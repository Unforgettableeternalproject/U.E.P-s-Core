@startuml CD-07-ç‹€æ…‹ç®¡ç†èˆ‡äººæ€§åŒ–å›æ‡‰

' StatusManager ç³»çµ±æ•¸å€¼ç®¡ç†èˆ‡äººæ€§åŒ–å›æ‡‰
' å±•ç¤ºå…§éƒ¨ç‹€æ…‹å¦‚ä½•å½±éŸ¿å„æ¨¡çµ„çš„è¡Œç‚º

skinparam classAttributeIconSize 0
skinparam class {
    BackgroundColor<<manager>> LightYellow
    BackgroundColor<<data>> Wheat
    BackgroundColor<<module>> LightBlue
    BorderColor DarkOrange
}

package "ç‹€æ…‹ç®¡ç†èˆ‡äººæ€§åŒ–å›æ‡‰ç³»çµ± (Status Management & Humanized Response)" {
    
    class StatusManager <<manager>> {
        ' ç³»çµ±ç‹€æ…‹ç®¡ç†å™¨ (å…¨å±€å–®ä¾‹)
        - status: SystemStatus
        - storage_path: Path
        - update_callbacks: Dict[str, Callable]
        - _helpfulness_override: Optional[float]
        - auto_save: bool
        - _lock: Lock
        --
        + get_status(): SystemStatus
        + get_status_dict(): Dict
        + update_mood(delta, reason): void
        + update_pride(delta, reason): void
        + update_helpfulness(delta, reason): void
        + update_boredom(delta, reason): void
        + reset_boredom(reason): void
        + record_interaction(successful, task_type): void
        + get_personality_modifiers(): Dict
        + register_update_callback(name, callback): void
        + save_status(): void
        + get_summary(): str
        --
        - _get_mood_level(): str
        - _get_pride_level(): str
        - _get_helpfulness_level(): str
        - _get_boredom_level(): str
        - _trigger_callbacks(field, old, new, reason): void
    }
    
    class SystemStatus <<data>> {
        ' ç³»çµ±ç‹€æ…‹æ•¸å€¼
        + mood: float = 0.0
        + pride: float = 0.0
        + helpfulness: float = 0.8
        + boredom: float = 0.0
        + total_interactions: int = 0
        + successful_tasks: int = 0
        + failed_tasks: int = 0
        + last_interaction_time: float = 0.0
        + last_update_reason: str = ""
        --
        + to_dict(): Dict
        + from_dict(data): SystemStatus
        + validate_ranges(): void
        + get(key, default): Any
    }
    
    class LLMModule <<module>> {
        ' LLM æ¨¡çµ„ (ç‹€æ…‹æ¶ˆè²»è€…)
        - prompt_manager: PromptManager
        - status_manager: StatusManager
        --
        + _build_system_prompt(): str
        + _on_status_update(type, old, new, reason): void
        - _apply_personality_to_prompt(modifiers): str
    }
    
    class TTSModule <<module>> {
        ' TTS æ¨¡çµ„ (ç‹€æ…‹æ¶ˆè²»è€…)
        - emotion_controller: EmotionController
        - status_manager: StatusManager
        --
        + synthesize_speech(text): bytes
        - _detect_emotion_from_status(): EmotionParams
        - _adjust_voice_parameters(mood, pride): Dict
    }
    
    class GeneralSession <<module>> {
        ' æœƒè©±ç®¡ç† (ç‹€æ…‹æ¶ˆè²»è€…)
        - status_manager: StatusManager
        --
        + start_session(): void
        + end_session(): void
        - _apply_session_penalties(): void
        - _record_session_outcome(successful): void
    }
}

' é—œä¿‚å®šç¾©
StatusManager "1" --> "1" SystemStatus : manages
StatusManager <.. LLMModule : observes
StatusManager <.. TTSModule : observes
StatusManager <.. GeneralSession : observes

' æ³¨é‡‹
note right of StatusManager
  **StatusManager è·è²¬**
  
  æ ¸å¿ƒæ•¸å€¼ (ç¯„åœ):
  - mood: æƒ…ç·’ (-1 è² é¢ ~ +1 æ­£é¢)
  - pride: è‡ªå°Šå¿ƒ (-1 è‡ªå‘ ~ +1 è‡ªä¿¡)
  - helpfulness: åŠ©äººæ„é¡˜ (0 ~ 1)
  - boredom: ç„¡èŠç¨‹åº¦ (0 ~ 1)
  
  æ•¸å€¼æ›´æ–°è§¸ç™¼:
  1. æˆåŠŸäº’å‹• â†’ moodâ†‘, prideâ†‘, helpfulnessâ†‘
  2. å¤±æ•—ä»»å‹™ â†’ moodâ†“, prideâ†“
  3. é•·æ™‚é–“ç„¡äº’å‹• â†’ boredomâ†‘
  4. æœƒè©±çµæŸ â†’ æ ¹æ“šé¡å‹èª¿æ•´
  
  å›èª¿æ©Ÿåˆ¶:
  - è¨»å†Š: register_update_callback(name, fn)
  - è§¸ç™¼: _trigger_callbacks(field, old, new, reason)
  - æ¨¡çµ„æ”¶åˆ°é€šçŸ¥ â†’ èª¿æ•´è¡Œç‚º
  
  æŒä¹…åŒ–:
  - è‡ªå‹•ä¿å­˜: memory/system_status.json
  - æ¯ 60 ç§’æˆ–æ•¸å€¼è®ŠåŒ–æ™‚ä¿å­˜
end note

note right of SystemStatus
  **ç³»çµ±ç‹€æ…‹æ•¸å€¼çµæ§‹**
  
  æ•¸å€¼ç¯„åœ:
  - mood: [-1.0, +1.0]
  - pride: [-1.0, +1.0]
  - helpfulness: [0.0, 1.0]
  - boredom: [0.0, 1.0]
  
  ç­‰ç´šæ˜ å°„ (mood ç¯„ä¾‹):
  - >= 0.6: éå¸¸é–‹å¿ƒ ğŸ˜„
  - >= 0.2: é–‹å¿ƒ ğŸ˜Š
  - >= -0.2: æ™®é€š ğŸ˜
  - >= -0.6: ä¸é–‹å¿ƒ ğŸ˜Ÿ
  - < -0.6: éå¸¸ä¸é–‹å¿ƒ ğŸ˜¢
  
  çµ±è¨ˆæ•¸æ“š:
  - ç¸½äº’å‹•æ¬¡æ•¸
  - æˆåŠŸ/å¤±æ•—ä»»å‹™æ•¸
  - ä¸Šæ¬¡äº’å‹•æ™‚é–“
  - æˆåŠŸç‡è¨ˆç®—
end note

note bottom of LLMModule
  **LLM æ¨¡çµ„çš„ç‹€æ…‹æ„ŸçŸ¥**
  
  æç¤ºè©æ³¨å…¥:
  ```
  Current Status:
  - Mood: Happy (0.5)
  - Pride: Confident (0.6)
  - Helpfulness: Very willing (0.9)
  - Boredom: Not bored (0.1)
  ```
  
  è¡Œç‚ºèª¿æ•´:
  1. mood < 0.3 â†’ ä½¿ç”¨æ›´æº«å’Œçš„èªæ°£
  2. pride < 0 â†’ é¿å…è¤‡é›œä»»å‹™,é™ä½æœŸæœ›
  3. helpfulness < 0.4 â†’ ç°¡çŸ­å›æ‡‰
  4. boredom > 0.8 â†’ ä¸»å‹•æå‡ºäº’å‹•å»ºè­°
  
  ç‹€æ…‹æ›´æ–°å›èª¿:
  ```python
  def _on_status_update(type, old, new, reason):
      if type == "mood" and new < 0.3:
          self.adjust_response_style("gentle")
      elif type == "boredom" and new > 0.8:
          self.suggest_interaction()
  ```
end note

note bottom of TTSModule
  **TTS æ¨¡çµ„çš„æƒ…æ„Ÿæ§åˆ¶**
  
  æ ¹æ“šç³»çµ±ç‹€æ…‹èª¿æ•´èªæ°£:
  
  mood å½±éŸ¿ pitch:
  - mood > 0.5 â†’ pitch +3 (é–‹å¿ƒéŸ³èª¿)
  - mood < -0.5 â†’ pitch -2 (ä½æ²‰éŸ³èª¿)
  
  pride å½±éŸ¿ energy:
  - pride > 0.5 â†’ energy 1.2 (æœ‰åŠ›)
  - pride < 0 â†’ energy 0.8 (è™›å¼±)
  
  helpfulness å½±éŸ¿ speed:
  - helpfulness > 0.8 â†’ speed 1.1 (ç©æ¥µ)
  - helpfulness < 0.4 â†’ speed 0.9 (æ¶ˆæ¥µ)
  
  ç¯„ä¾‹:
  ```python
  status = status_manager.get_status()
  emotion_params = EmotionParams(
      pitch = status.mood * 3.0,
      speed = 0.8 + status.helpfulness * 0.4,
      energy = 0.9 + status.pride * 0.3
  )
  ```
end note

note bottom of GeneralSession
  **æœƒè©±ç®¡ç†çš„ç‹€æ…‹äº¤äº’**
  
  æœƒè©±é–‹å§‹:
  - é‡ç½® boredom â†’ 0
  - è¨˜éŒ„é–‹å§‹æ™‚é–“
  
  æœƒè©±çµæŸ:
  - æ‡‰ç”¨æ‡²ç½° (é•·æ™‚é–“æœƒè©±)
    * mood -= session_duration / 3600 * 0.1
    * boredom += 0.05
  
  - è¨˜éŒ„çµæœ
    * æˆåŠŸ â†’ prideâ†‘, helpfulnessâ†‘
    * å¤±æ•— â†’ prideâ†“, moodâ†“
  
  ç¯„ä¾‹:
  ```python
  def end_session(self):
      penalties = status_manager.apply_session_penalties(
          session_type="chat"
      )
      
      if self.task_successful:
          status_manager.record_interaction(
              successful=True,
              task_type="conversation"
          )
      else:
          status_manager.record_interaction(
              successful=False
          )
  ```
end note

note as N1
  **å®Œæ•´ç‹€æ…‹æ›´æ–°æµç¨‹**
  
  ç¯„ä¾‹: ç”¨æˆ¶æˆåŠŸäº’å‹•
  
  1. GeneralSession.end_session()
     â†’ status_manager.record_interaction(successful=True)
  
  2. StatusManager æ›´æ–°æ•¸å€¼
     - mood: 0.0 â†’ +0.05 (æˆåŠŸäº’å‹•)
     - pride: 0.2 â†’ +0.1 (æˆåŠŸå®Œæˆ)
     - helpfulness: 0.8 â†’ +0.01 (æˆåŠŸå¹«åŠ©)
     - boredom: 0.3 â†’ 0.0 (é‡ç½®)
  
  3. è§¸ç™¼å›èª¿é€šçŸ¥
     â†’ LLMModule._on_status_update("mood", 0.0, 0.05, "æˆåŠŸäº’å‹•")
     â†’ TTSModule._on_status_update("mood", 0.0, 0.05, "æˆåŠŸäº’å‹•")
  
  4. æ¨¡çµ„èª¿æ•´è¡Œç‚º
     - LLM: ä½¿ç”¨æ›´ç©æ¥µçš„æç¤ºè©
     - TTS: æé«˜éŸ³èª¿å’Œèƒ½é‡
  
  5. ä¿å­˜ç‹€æ…‹
     â†’ status_manager.save_status()
     â†’ memory/system_status.json
  
  çµæœ: ä¸‹æ¬¡å°è©±æ›´æœ‰æ´»åŠ›!
end note

@enduml
