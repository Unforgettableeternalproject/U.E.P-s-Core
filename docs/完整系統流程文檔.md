# U.E.P 完整系統流程文檔

## 系統啟動流程

### 1. Production Runner 啟動
```
production_runner.py
├── 調用 SystemInitializer 初始化系統
├── 啟動 SystemLoop 主循環  
└── 等待用戶中斷或系統關閉
```

### 2. System Initializer 初始化序列
```
SystemInitializer
├── Controller 啟動 Framework 初始化
├── Framework 自動發現和註冊模組
├── Router 初始化（做第一次啟動準備）
├── State Manager 和 Session Manager 初始化
├── Working Context 清理和準備
└── 系統健康檢查
```

### 3. System Loop 主循環運作

#### 循環前準備
- 等待使用者輸入（STT 持續監聽）
- 系統處於 IDLE 狀態

#### 單次處理循環
```
1. [輸入層] STT 接收語音 → 若目前不存在 GS，則啟動 GS
   └── 輸出結構化語音數據

2. [輸入層] NLP 分析意圖和身份
   ├── 分析用戶意圖
   ├── 識別語者身份  
   ├── 建議狀態轉換（CHAT/WORK）
   └── 輸出 NLP 分析結果

3. [路由層] Router 根據 NLP 分析結果
   ├── 決定狀態轉換（IDLE → CHAT/WORK）
   ├── 啟動對應會話（CS/WS）
   └── 路由到對應處理模組

4a. [CHAT 路徑] 聊天處理流程
    ├── 啟動 Chatting Session (CS)
    ├── MEM 模組記憶查詢（從 WC 獲取身份資料）
    ├── LLM 模組對話生成（從狀態/會話管理器獲取上下文）
    ├── MEM 模組快照存儲
    └── 結果傳遞給 Router

4b. [WORK 路徑] 工作處理流程  
    ├── 啟動 Workflow Session (WS)
    ├── LLM 釐清工作目標（從 WC 和會話管理器獲取資料）
    ├── SYS + LLM 互動執行工作流
    ├── LLM 步驟結尾處理
    └── 結果傳遞給 Router

5. [輸出層] Router 轉送結果
   ├── 接收處理結果
   ├── 轉送給 TTS 模組
   └── TTS 語音輸出

6. [循環結束] 狀態回歸和 GS 管理
   ├── 狀態佇列清空 → 狀態回歸 IDLE
   ├── 會話結束判斷 (在此循環中被呼叫結束點的會話在此處結束)
   └── Framework 蒐集效能快照
```

#### GS (General Session) 生命週期
- **啟動時機**: 第一次接收使用者輸入時
- **持續條件**: 狀態佇列中至少有一個新狀態存在
- **結束條件**: 狀態佇列完全清空
- **跨循環**: 同一個 GS 可以跨越多個處理循環

#### 效能監控整合
- 每次循環結束時，Framework 蒐集系統效能快照
- 模組通過 `framework.update_module_metrics()` 報告效能指標
- System Loop 定期調用 `framework.collect_system_performance_snapshot()`

## 核心組件職責

### Controller
- 系統級監督和觸發
- GS 生命週期管理
- 系統健康檢查

### Framework  
- 模組註冊和管理
- 系統流程骨架定義
- 效能指標蒐集

### Router
- 意圖路由和狀態轉換
- 會話啟動協調
- 模組間數據轉送

### State Manager
- UEP 狀態管理
- 狀態轉換邏輯
- 狀態佇列整合

### Session Manager
- 三層會話管理（GS/CS/WS）
- 會話生命週期協調
- 跨會話資料保留

### Working Context
- 跨模組資料共享
- 身份和上下文管理
- 決策處理器協調

## 數據流向

```
[用戶語音] 
    ↓ STT
[STTModuleData] 
    ↓ NLP
[NLPModuleData] 
    ↓ Router
[狀態轉換 + 會話啟動]
    ↓
┌─ CHAT ─────────┐  ┌─ WORK ─────────┐
│ CS 啟動        │  │ WS 啟動        │
│ MEM ↔ WC       │  │ LLM ↔ WC       │  
│ LLM ↔ 會話     │  │ SYS ↔ 會話     │
│ MEM 快照       │  │ 工作流執行     │
└────────────────┘  └────────────────┘
    ↓ Router
[處理結果]
    ↓ TTS  
[語音輸出]
```

## 錯誤處理和恢復

### 模組級錯誤
- 模組內部異常捕捉
- 錯誤狀態報告給 Framework
- 效能指標中記錄錯誤計數

### 會話級錯誤
- 會話異常自動恢復
- 強制會話結束機制
- 狀態回歸 IDLE

### 系統級錯誤
- Controller 系統健康檢查
- 自動重啟機制
- 優雅關閉處理

## 設計原則

1. **分層責任**: 每層專注自己的職責，避免越級調用
2. **狀態驅動**: 所有流程基於系統狀態變化
3. **會話隔離**: 不同會話類型有明確邊界
4. **數據一致性**: Working Context 保證跨模組數據一致
5. **可監控性**: 完整的效能監控和日誌記錄
6. **可恢復性**: 各層級都有錯誤恢復機制