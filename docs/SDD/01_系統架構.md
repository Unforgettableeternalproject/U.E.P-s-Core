# ç¬¬ä¸€ç« ï¼šç³»çµ±æ¶æ§‹ (System Architecture)

[â† è¿”å›ä¸»æ–‡ä»¶](../System%20Design%20Documentation.md)

---

## 1.1 ç³»çµ±æ¶æ§‹æ¦‚è¦½ (System Architecture Overview)

U.E.P ç³»çµ±æ¡ç”¨**æ¨¡çµ„åŒ–ä¸‰å±¤äº‹ä»¶é©…å‹•æ¶æ§‹**ï¼Œé€éä¸­å¤® Event Bus å¯¦ç¾é¬†è€¦åˆçš„æ¨¡çµ„é€šè¨Šã€‚

### 1.1.1 æ•´é«”æ¶æ§‹åœ– (System Architecture Diagram)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä½¿ç”¨è€… (User)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ èªéŸ³è¼¸å…¥                                    â”‚ è¦–è¦ºè¼¸å‡º
             â†“                                            â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å‰ç«¯æ•´åˆå±¤ (Frontend Layer)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  UI Module   â”‚  â”‚ ANI Module   â”‚  â”‚  MOV Module  â”‚             â”‚
â”‚  â”‚ (æ¡Œé¢å¯µç‰©)    â”‚  â”‚ (å‹•ç•«æ§åˆ¶)    â”‚  â”‚ (ç§»å‹•æ§åˆ¶)    â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                            â†‘
             â”‚ Frontend Adapter (å³å°‡å¯¦ç¾)                 â”‚
             â†“                                            â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ ¸å¿ƒæ§åˆ¶å±¤ (Core Control Layer)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Event Bus (äº‹ä»¶åŒ¯æµæ’)                     â”‚   â”‚
â”‚  â”‚  â€¢ INPUT_LAYER_COMPLETE   â€¢ PROCESSING_LAYER_COMPLETE       â”‚   â”‚
â”‚  â”‚  â€¢ OUTPUT_LAYER_COMPLETE  â€¢ CYCLE_COMPLETED                 â”‚   â”‚
â”‚  â”‚  â€¢ WORKFLOW_STEP_COMPLETED â€¢ SESSION_ENDED                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚Controller â”‚  â”‚  Framework   â”‚  â”‚   Router    â”‚  â”‚  States  â”‚  â”‚
â”‚  â”‚  (GSç®¡ç†) â”‚  â”‚ (æ¨¡çµ„è¨»å†Š)    â”‚  â”‚ (æ–‡å­—è·¯ç”±)   â”‚  â”‚ (ç‹€æ…‹æ©Ÿ)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Sessions  â”‚  â”‚ Module         â”‚  â”‚  Working Context     â”‚   â”‚
â”‚  â”‚ (GS/CS/WS)  â”‚  â”‚ Coordinator    â”‚  â”‚  (è·¨æ¨¡çµ„è³‡æ–™å…±äº«)     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                            â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¼¸å…¥å±¤ (Input Layer)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚      STT Module          â”‚  â”‚      (UI Module)         â”‚        â”‚
â”‚  â”‚  â€¢ Whisper-large-v3      â”‚  â”‚  â€¢ æ–‡å­—è¼¸å…¥æ¨¡å¼            â”‚        â”‚
â”‚  â”‚  â€¢ Pyannote Speaker ID   â”‚  â”‚                          â”‚        â”‚
â”‚  â”‚  â€¢ VAD (Energy-based)    â”‚  â”‚                          â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                      â”‚                                              â”‚
â”‚                      â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    NLP Module                                 â”‚  â”‚
â”‚  â”‚  â€¢ Intent Segmentation (BIOS Tagger)                         â”‚  â”‚
â”‚  â”‚  â€¢ Identity Management                                       â”‚  â”‚
â”‚  â”‚  â€¢ State Decision Authority (IDLE â†’ CHAT/WORK)              â”‚  â”‚
â”‚  â”‚  â€¢ Multi-Intent Context                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                      â”‚ [Publishes: INPUT_LAYER_COMPLETE]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è™•ç†å±¤ (Processing Layer)                          â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    MEM Module                                â”‚   â”‚
â”‚  â”‚  â€¢ FAISS Vector Database (384-dim)                          â”‚   â”‚
â”‚  â”‚  â€¢ Sentence Transformers (all-MiniLM-L6-v2)                 â”‚   â”‚
â”‚  â”‚  â€¢ Identity-Isolated Memory                                 â”‚   â”‚
â”‚  â”‚  â€¢ Snapshot Manager (Conversation Snapshots)                â”‚   â”‚
â”‚  â”‚  â€¢ Semantic Retriever (Multi-Strategy RAG)                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    LLM Module                                â”‚   â”‚
â”‚  â”‚  â€¢ Google Gemini 2.5 Flash Lite (Vertex AI)                 â”‚   â”‚
â”‚  â”‚  â€¢ Structured Output (Pydantic Schemas)                     â”‚   â”‚
â”‚  â”‚  â€¢ MCP Client (Model Context Protocol)                      â”‚   â”‚
â”‚  â”‚  â€¢ Collaboration Channels:                                  â”‚   â”‚
â”‚  â”‚    - CHAT_MEM: LLM â†” MEM (è¨˜æ†¶å¢å¼·å°è©±)                      â”‚   â”‚
â”‚  â”‚    - WORK_SYS: LLM â†” SYS (å·¥ä½œæµæ±ºç­–èˆ‡åŸ·è¡Œ)                   â”‚   â”‚
â”‚  â”‚  â€¢ Context Caching (Gemini + Local)                         â”‚   â”‚
â”‚  â”‚  â€¢ Learning Engine (User Preference Tracking)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    SYS Module                                â”‚   â”‚
â”‚  â”‚  â€¢ Workflow Engine (Step-by-Step Execution)                 â”‚   â”‚
â”‚  â”‚  â€¢ MCP Server (Tool Protocol for LLM)                       â”‚   â”‚
â”‚  â”‚  â€¢ Background Task Executor (ThreadPoolExecutor)            â”‚   â”‚
â”‚  â”‚  â€¢ Function Registry (YAML-based)                           â”‚   â”‚
â”‚  â”‚  â€¢ Actions: Window Control, Text Processing, Integrations   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                      â”‚ [Publishes: PROCESSING_LAYER_COMPLETE]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¼¸å‡ºå±¤ (Output Layer)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    TTS Module                                 â”‚  â”‚
â”‚  â”‚  â€¢ IndexTTS Lite Engine (Custom Transformer TTS)             â”‚  â”‚
â”‚  â”‚  â€¢ BigVGAN Vocoder (nvidia/bigvgan_v2_24khz)                 â”‚  â”‚
â”‚  â”‚  â€¢ Emotion Mapper (8D: happy, angry, sad, afraid, ...)      â”‚  â”‚
â”‚  â”‚  â€¢ TTS Chunker (Producer/Consumer Streaming)                 â”‚  â”‚
â”‚  â”‚  â€¢ Status Manager Integration (Mood/Pride/Helpfulness)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                      â”‚ [Publishes: OUTPUT_LAYER_COMPLETE]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
                   èªéŸ³è¼¸å‡º / UI é¡¯ç¤º
```

### 1.1.2 æ¶æ§‹ç‰¹é» (Architecture Highlights)

#### 1. äº‹ä»¶é©…å‹• (Event-Driven)
- **Event Bus æ ¸å¿ƒ**: æ‰€æœ‰å±¤ç´šè½‰æ›é€é `core/event_bus.py` è§£è€¦
- **éåŒæ­¥è™•ç†**: æ¨¡çµ„é–“ç„¡ç›´æ¥ä¾è³´ï¼Œåƒ…é€éäº‹ä»¶è¨‚é–±/ç™¼å¸ƒé€šè¨Š
- **Flow-Based Deduplication**: é˜²æ­¢é‡è¤‡è™•ç† (`session_id:cycle_index:layer`)

#### 2. ä¸‰å±¤è™•ç†æ¨¡å‹ (Three-Layer Processing)
| å±¤ç´š | è·è²¬ | ä¸»è¦æ¨¡çµ„ | å®Œæˆäº‹ä»¶ |
|:---:|:---|:---|:---|
| **Input Layer** | æ„ŸçŸ¥ä½¿ç”¨è€…è¼¸å…¥ã€æ±ºå®šç³»çµ±ç‹€æ…‹ | STT, NLP | `INPUT_LAYER_COMPLETE` |
| **Processing Layer** | æ ¹æ“šç‹€æ…‹åŸ·è¡Œå°è©±æˆ–å·¥ä½œæµ | MEM, LLM, SYS | `PROCESSING_LAYER_COMPLETE` |
| **Output Layer** | èªéŸ³åˆæˆèˆ‡ UI å‘ˆç¾ | TTS, UI | `OUTPUT_LAYER_COMPLETE` |

#### 3. æœƒè©±æ¶æ§‹ (Session Architecture)
```
General Session (GS) â”€â”€â”€â”¬â”€â”€ Chatting Session (CS)
ç³»çµ±ç´šï¼Œè·¨è¶Šæ•´å€‹å°è©±      â”‚   CHAT ç‹€æ…‹å°ˆç”¨
ç”Ÿå‘½é€±æœŸ                 â”‚   è¨˜æ†¶éš”é›¢ (memory_token)
                        â”‚   
                        â””â”€â”€ Workflow Session (WS)
                            WORK ç‹€æ…‹å°ˆç”¨
                            å·¥ä½œæµç‹€æ…‹æŒä¹…åŒ–
```

**æœƒè©±ç”Ÿå‘½é€±æœŸ**:
- **GS**: ç¬¬ä¸€æ¬¡è¼¸å…¥é–‹å§‹ â†’ ç‹€æ…‹ä½‡åˆ—æ¸…ç©ºçµæŸ
- **CS**: CHAT ç‹€æ…‹é€²å…¥å‰µå»º â†’ CHAT ç‹€æ…‹é€€å‡ºçµæŸ
- **WS**: WORK ç‹€æ…‹é€²å…¥å‰µå»º â†’ å·¥ä½œæµå®Œæˆæˆ–å–æ¶ˆçµæŸ

#### 4. å”ä½œé€šé“ (Collaboration Channels)
| é€šé“ | æ–¹å‘ | ç”¨é€” | è³‡æ–™æä¾›è€… |
|:---:|:---:|:---|:---|
| **CHAT_MEM** | LLM â†” MEM | è¨˜æ†¶æª¢ç´¢å¢å¼·å°è©± | MEM Module |
| **WORK_SYS** | LLM â†” SYS | å·¥ä½œæµç‹€æ…‹èˆ‡å‡½æ•¸è¨»å†Š | SYS Module |

**è‡ªå‹•ç®¡ç†**: LLM Module æ ¹æ“šç³»çµ±ç‹€æ…‹è‡ªå‹•å•Ÿç”¨/åœç”¨å°æ‡‰é€šé“

#### 5. ç‹€æ…‹ç®¡ç† (State Management)
```
UEPState ç‹€æ…‹æ©Ÿ:
IDLE â”€â”€â†’ CHAT (å°è©±æ¨¡å¼)
    â””â”€â”€â†’ WORK (å·¥ä½œæµæ¨¡å¼)
    â””â”€â”€â†’ ERROR (éŒ¯èª¤è™•ç†)
```

**ç‹€æ…‹æ±ºç­–æ¬Š**: NLP Module åˆ†ææ„åœ–å¾Œæ±ºå®šç‹€æ…‹è½‰æ›

---

## 1.2 å­ç³»çµ±åŠŸèƒ½èˆ‡ä»‹é¢ (Subsystem Requirements and Interfaces)

### 1.2.1 æ ¸å¿ƒæ§åˆ¶å±¤ (Core Control Layer)

| å­ç³»çµ± ID | å­ç³»çµ±åç¨± | ä¸»è¦åŠŸèƒ½ | æª”æ¡ˆè·¯å¾‘ |
|:---:|:---|:---|:---|
| **CORE-001** | Controller | General Session ç”Ÿå‘½é€±æœŸç®¡ç†ã€ç³»çµ±å¥åº·ç›£æ§ | `core/controller.py` |
| **CORE-002** | Framework | æ¨¡çµ„è‡ªå‹•ç™¼ç¾èˆ‡è¨»å†Šã€æ•ˆèƒ½ç›£æ§ | `core/framework.py` |
| **CORE-003** | Event Bus | äº‹ä»¶ç™¼å¸ƒ/è¨‚é–±ã€éåŒæ­¥äº‹ä»¶è™•ç† | `core/event_bus.py` |
| **CORE-004** | Module Coordinator | å±¤ç´šè½‰æ›å”èª¿ã€Flow-Based å»é‡ | `core/module_coordinator.py` |
| **CORE-005** | Router | ç´”æ–‡å­—è·¯ç”±ã€è¡¨æƒ…ç¬¦è™Ÿéæ¿¾ | `core/router.py` |
| **CORE-006** | State Manager | ç³»çµ±ç‹€æ…‹è¿½è¹¤ã€ç‹€æ…‹ä½‡åˆ—æ•´åˆ | `core/states/state_manager.py` |
| **CORE-007** | Session Manager | çµ±ä¸€æœƒè©±å”èª¿ (GS/CS/WS) | `core/sessions/session_manager.py` |
| **CORE-008** | Working Context | è·¨æ¨¡çµ„è³‡æ–™å…±äº«ã€æ±ºç­–è§¸ç™¼ | `core/working_context.py` |
| **CORE-009** | Status Manager | æƒ…ç·’å€¼è¿½è¹¤ (mood/pride/helpfulness/boredom) | `core/status_manager.py` |
| **CORE-010** | System Initializer | 7 éšæ®µç³»çµ±åˆå§‹åŒ– | `core/system_initializer.py` |
| **CORE-011** | System Loop | ä¸»è™•ç†è¿´åœˆã€é€±æœŸè¿½è¹¤ | `core/system_loop.py` |

### 1.2.2 è¼¸å…¥å±¤æ¨¡çµ„ (Input Layer Modules)

| æ¨¡çµ„ ID | æ¨¡çµ„åç¨± | ä¸»è¦åŠŸèƒ½ | æ ¸å¿ƒæŠ€è¡“ |
|:---:|:---|:---|:---|
| **INPUT-001** | STT Module | èªéŸ³è½‰æ–‡å­—ã€èªªè©±è€…è­˜åˆ¥ | Whisper-large-v3, Pyannote |
| **INPUT-002** | NLP Module | æ„åœ–åˆ†æã€èº«ä»½ç®¡ç†ã€ç‹€æ…‹æ±ºç­– | BIOS Tagger, IdentityManager |

### 1.2.3 è™•ç†å±¤æ¨¡çµ„ (Processing Layer Modules)

| æ¨¡çµ„ ID | æ¨¡çµ„åç¨± | ä¸»è¦åŠŸèƒ½ | æ ¸å¿ƒæŠ€è¡“ |
|:---:|:---|:---|:---|
| **PROC-001** | MEM Module | å‘é‡è¨˜æ†¶å„²å­˜èˆ‡æª¢ç´¢ | FAISS, Sentence Transformers |
| **PROC-002** | LLM Module | å¤§å‹èªè¨€æ¨¡å‹æ¨ç†ã€çµæ§‹åŒ–è¼¸å‡º | Gemini 2.5 Flash, MCP Client |
| **PROC-003** | SYS Module | å·¥ä½œæµå¼•æ“ã€ç³»çµ±æŒ‡ä»¤åŸ·è¡Œ | MCP Server, ThreadPoolExecutor |

### 1.2.4 è¼¸å‡ºå±¤æ¨¡çµ„ (Output Layer Modules)

| æ¨¡çµ„ ID | æ¨¡çµ„åç¨± | ä¸»è¦åŠŸèƒ½ | æ ¸å¿ƒæŠ€è¡“ |
|:---:|:---|:---|:---|
| **OUTPUT-001** | TTS Module | æ–‡å­—è½‰èªéŸ³ã€æƒ…ç·’è¡¨é” | IndexTTS Lite, BigVGAN |
| **OUTPUT-002** | UI Module | æ¡Œé¢å¯µç‰©ä»‹é¢ | PyQt5 (å¯é¸) |

### 1.2.5 å‰ç«¯æ•´åˆå±¤ (Frontend Integration Layer) - å³å°‡å¯¦ç¾

| æ¨¡çµ„ ID | æ¨¡çµ„åç¨± | ç‹€æ…‹ | é è¨ˆåŠŸèƒ½ |
|:---:|:---|:---:|:---|
| **FRONT-001** | Frontend Adapter | ğŸ”„ è¨ˆåŠƒä¸­ | å¾Œç«¯æ§åˆ¶å™¨èˆ‡å‰ç«¯ UI çš„æ©‹æ¥ |
| **FRONT-002** | ANI Module | ğŸ“‹ å¾…æ•´åˆ | å‹•ç•«ç‹€æ…‹åŒæ­¥ |
| **FRONT-003** | MOV Module | ğŸ“‹ å¾…æ•´åˆ | ç§»å‹•æ§åˆ¶åŒæ­¥ |

**Frontend Adapter è¨­è¨ˆåŸå‰‡**:
- ç›£è½å¾Œç«¯ç³»çµ±ç‹€æ…‹è®ŠåŒ– (`StateManager`)
- å°‡è™•ç†å±¤é€²åº¦æ˜ å°„åˆ°å‹•ç•«ç‹€æ…‹
- åŒæ­¥ TTS æ’­æ”¾èˆ‡å£å‹å‹•ç•«
- é›™å‘äº‹ä»¶é€šè¨Š (Backend â†” Frontend)

### 1.2.6 ä¸»è¦ä»‹é¢å®šç¾© (Interface Definitions)

| ä»‹é¢ ID | ä»‹é¢åç¨± | é¡å‹ | èªªæ˜ |
|:---:|:---|:---:|:---|
| **INT-001** | Event Bus Interface | Event | æ¨™æº–äº‹ä»¶é¡å‹ (SystemEvent Enum) |
| **INT-002** | Module Handle Interface | Method | æ‰€æœ‰æ¨¡çµ„å¯¦ä½œ `handle(input) -> output` |
| **INT-003** | Collaboration Channel Interface | Data Provider | æ¨¡çµ„è¨»å†Šè³‡æ–™æä¾›è€… |
| **INT-004** | Working Context Interface | Shared Data | è·¨æ¨¡çµ„è³‡æ–™å­˜å– |
| **INT-005** | Session Interface | Lifecycle | æœƒè©±å‰µå»º/æŸ¥è©¢/çµæŸ |
| **INT-006** | MCP Protocol Interface | RPC | LLM â†” SYS å·¥å…·èª¿ç”¨ |
| **INT-007** | Frontend Adapter Interface | ğŸ”„ Event/State | å¾Œç«¯ â†” å‰ç«¯ç‹€æ…‹åŒæ­¥ |

---

## 1.3 æŠ€è¡“è§£æ±ºæ–¹æ¡ˆé™åˆ¶ (Technical Solution Criteria)

### 1.3.1 å„ªå…ˆæ¬¡åºè¡¨ (Priority Matrix)

ä¾ç…§ç³»çµ±éœ€æ±‚ï¼Œæœ¬è¨­è¨ˆæ–‡ä»¶æ“¬å®šå„ç¨®é™åˆ¶çš„å„ªå…ˆé †åºå¦‚ä¸‹ï¼š

| è€ƒé‡å› ç´  (Issue) | ä½¿ç”¨è€…å„ªå…ˆç´š | é–‹ç™¼è€…å„ªå…ˆç´š | ç³»çµ±å„ªå…ˆç´š |
|:---|:---:|:---:|:---:|
| **æ¨¡çµ„åŒ– (Modularity)** | 2 | 1 | 1 |
| **å¯ç¶­è­·æ€§ (Maintainability)** | 2 | 1 | 1 |
| **æ•ˆèƒ½ (Performance)** | 1 | 2 | 1 |
| **å¯æ“´å±•æ€§ (Scalability)** | 2 | 1 | 1 |
| **æ˜“ç”¨æ€§ (Usability)** | 1 | 2 | 2 |
| **é–‹ç™¼é€Ÿåº¦ (Development Speed)** | 2 | 2 | 3 |
| **æˆæœ¬ (Cost)** | 2 | 2 | 2 |

*å„ªå…ˆç´š (Scale: 1=æœ€é‡è¦, 3=æ¬¡è¦)*

### 1.3.2 ç¯©é¸é™åˆ¶ (Screening Criteria)

ä¾ç…§ä¸Šè¿°çš„å„ªå…ˆæ¬¡åºè¡¨ï¼Œç™¼å±•ä»¥ä¸‹ç¯©é¸é™åˆ¶ï¼š

| é™åˆ¶ ID | é™åˆ¶åç¨± | èªªæ˜ | æ¬Šé‡ |
|:---:|:---|:---|:---:|
| **CRI-001** | æ¨¡çµ„é¬†è€¦åˆ (Loose Coupling) | æ¨¡çµ„é–“é€éäº‹ä»¶é€šè¨Šï¼Œç„¡ç›´æ¥ä¾è³´ | â­â­â­ |
| **CRI-002** | æ¸¬è©¦æ€§ (Testability) | æ¯å€‹æ¨¡çµ„å¯ç¨ç«‹æ¸¬è©¦ | â­â­â­ |
| **CRI-003** | è™•ç†å»¶é² (Processing Latency) | èªéŸ³è¼¸å…¥åˆ°è¼¸å‡º < 3 ç§’ (CHAT æ¨¡å¼) | â­â­ |
| **CRI-004** | è¨˜æ†¶é«”ä½¿ç”¨ (Memory Usage) | ç³»çµ±å¸¸é§è¨˜æ†¶é«” < 4GB | â­â­ |
| **CRI-005** | å¯æ“´å±•æ€§ (Extensibility) | æ–°å¢æ¨¡çµ„ç„¡éœ€ä¿®æ”¹æ ¸å¿ƒç¨‹å¼ç¢¼ | â­â­â­ |
| **CRI-006** | éŒ¯èª¤æ¢å¾© (Error Recovery) | å–®ä¸€æ¨¡çµ„éŒ¯èª¤ä¸å½±éŸ¿ç³»çµ±é‹è¡Œ | â­â­â­ |
| **CRI-007** | é…ç½®éˆæ´»æ€§ (Configuration Flexibility) | æ‰€æœ‰åƒæ•¸å¯é€é YAML è¨­å®š | â­â­ |
| **CRI-008** | Python ç‰ˆæœ¬ç›¸å®¹æ€§ | æ”¯æ´ Python 3.10+ | â­â­â­ |

---

## 1.4 æ¶æ§‹æ–¹æ¡ˆæ¯”è¼ƒ (Alternative Architecture Solutions)

### 1.4.1 æ–¹æ¡ˆæ¦‚è¿°

æœ¬å°ˆæ¡ˆåœ¨è¨­è¨ˆéšæ®µè©•ä¼°äº†ä»¥ä¸‹ä¸‰ç¨®æ¶æ§‹æ–¹æ¡ˆï¼š

| æ–¹æ¡ˆ | é¡å‹ | èªªæ˜ |
|:---:|:---|:---|
| **æ–¹æ¡ˆ A** | Monolithic Architecture | å–®é«”å¼æ¶æ§‹ï¼Œæ‰€æœ‰åŠŸèƒ½æ•´åˆåœ¨å–®ä¸€ç¨‹å¼ä¸­ |
| **æ–¹æ¡ˆ B** | Direct Call Architecture | æ¨¡çµ„é–“ç›´æ¥èª¿ç”¨ï¼Œç„¡ä¸­ä»‹å±¤ |
| **æ–¹æ¡ˆ C** | Event-Driven Architecture | äº‹ä»¶é©…å‹•æ¶æ§‹ï¼Œé€é Event Bus è§£è€¦ âœ… (å·²é¸ç”¨) |

### 1.4.2 è©³ç´°æ¯”è¼ƒ

#### æ–¹æ¡ˆ A: Monolithic Architecture (å–®é«”å¼æ¶æ§‹)

**å„ªé»**:
- é–‹ç™¼åˆæœŸé€Ÿåº¦å¿«
- ç„¡æ¨¡çµ„é–“é€šè¨Šé–‹éŠ·
- é™¤éŒ¯å®¹æ˜“ (å–®ä¸€åŸ·è¡Œè·¯å¾‘)

**ç¼ºé»**:
- é›£ä»¥æ“´å±• (æ–°å¢åŠŸèƒ½éœ€ä¿®æ”¹æ ¸å¿ƒç¨‹å¼ç¢¼)
- æ¸¬è©¦å›°é›£ (ç„¡æ³•éš”é›¢æ¸¬è©¦å–®ä¸€åŠŸèƒ½)
- ç¶­è­·æˆæœ¬é«˜ (ä¿®æ”¹å½±éŸ¿ç¯„åœå¤§)
- ç„¡æ³•æ”¯æ´å‹•æ…‹æ¨¡çµ„è¼‰å…¥

**è©•åˆ†** (ä¾ 1.3.2 æ¨™æº–):
| é™åˆ¶ | å¾—åˆ† | èªªæ˜ |
|:---|:---:|:---|
| æ¨¡çµ„é¬†è€¦åˆ | 2/10 | æ‰€æœ‰åŠŸèƒ½ç·Šå¯†è€¦åˆ |
| æ¸¬è©¦æ€§ | 3/10 | é›£ä»¥å–®å…ƒæ¸¬è©¦ |
| è™•ç†å»¶é² | 8/10 | ç„¡é€šè¨Šé–‹éŠ· |
| è¨˜æ†¶é«”ä½¿ç”¨ | 7/10 | å–®ä¸€ç¨‹åº |
| å¯æ“´å±•æ€§ | 2/10 | æ“´å±•å›°é›£ |
| éŒ¯èª¤æ¢å¾© | 2/10 | å–®é»å¤±æ•— |
| é…ç½®éˆæ´»æ€§ | 5/10 | æœ‰é™æ”¯æ´ |
| **ç¸½åˆ†** | **29/80** | |

---

#### æ–¹æ¡ˆ B: Direct Call Architecture (ç›´æ¥èª¿ç”¨æ¶æ§‹)

**å„ªé»**:
- æ¨¡çµ„åŒ–è¨­è¨ˆ
- åŸ·è¡Œæµç¨‹æ¸…æ™°
- é–‹ç™¼ç›¸å°ç°¡å–®

**ç¼ºé»**:
- æ¨¡çµ„é–“å­˜åœ¨ç›´æ¥ä¾è³´
- é›£ä»¥æ›¿æ›æˆ–å‡ç´šå–®ä¸€æ¨¡çµ„
- æ¸¬è©¦éœ€è¦ mock ä¾è³´æ¨¡çµ„
- æµç¨‹è®Šæ›´éœ€ä¿®æ”¹å¤šè™•ç¨‹å¼ç¢¼

**å¯¦éš›æ¡ˆä¾‹** (æœ¬å°ˆæ¡ˆ Phase 1):
```python
# deprecated/router_old.py
class OldRouter:
    def process_text(self, text):
        # ç›´æ¥èª¿ç”¨æ¨¡çµ„
        nlp_result = nlp_module.analyze(text)
        if nlp_result.intent == "CHAT":
            mem_result = mem_module.retrieve(text)
            llm_result = llm_module.generate(text, mem_result)
            tts_module.synthesize(llm_result.text)
```

**è©•åˆ†**:
| é™åˆ¶ | å¾—åˆ† | èªªæ˜ |
|:---|:---:|:---|
| æ¨¡çµ„é¬†è€¦åˆ | 5/10 | æ¨¡çµ„åŒ–ä½†æœ‰ç›´æ¥ä¾è³´ |
| æ¸¬è©¦æ€§ | 6/10 | éœ€è¦ mock ä¾è³´ |
| è™•ç†å»¶é² | 8/10 | æœ€å°é€šè¨Šé–‹éŠ· |
| è¨˜æ†¶é«”ä½¿ç”¨ | 7/10 | å–®ä¸€ç¨‹åº |
| å¯æ“´å±•æ€§ | 5/10 | å¯æ“´å±•ä½†éœ€ä¿®æ”¹èª¿ç”¨æ–¹ |
| éŒ¯èª¤æ¢å¾© | 4/10 | ä¾è³´éˆä¸­æ–·å½±éŸ¿å…¨å±€ |
| é…ç½®éˆæ´»æ€§ | 6/10 | æ”¯æ´æ¨¡çµ„é…ç½® |
| **ç¸½åˆ†** | **41/80** | |

---

#### æ–¹æ¡ˆ C: Event-Driven Architecture (äº‹ä»¶é©…å‹•æ¶æ§‹) âœ…

**å„ªé»**:
- å®Œå…¨é¬†è€¦åˆ (æ¨¡çµ„é–“ç„¡ç›´æ¥ä¾è³´)
- æ˜“æ–¼æ¸¬è©¦ (æ¨¡çµ„ç¨ç«‹æ¸¬è©¦)
- æ”¯æ´éåŒæ­¥è™•ç†
- æ–°å¢æ¨¡çµ„ç„¡éœ€ä¿®æ”¹ç¾æœ‰ç¨‹å¼ç¢¼
- éŒ¯èª¤éš”é›¢ (å–®ä¸€æ¨¡çµ„å¤±æ•—ä¸å½±éŸ¿å…¶ä»–æ¨¡çµ„)
- æ”¯æ´æµç¨‹å»é‡ (Flow-Based Deduplication)

**ç¼ºé»**:
- åˆå§‹é–‹ç™¼è¤‡é›œåº¦è¼ƒé«˜
- é™¤éŒ¯ç›¸å°å›°é›£ (éç·šæ€§åŸ·è¡Œæµç¨‹)
- æœ‰äº‹ä»¶é€šè¨Šé–‹éŠ·
- éœ€è¦è‰¯å¥½çš„äº‹ä»¶è¨­è¨ˆ

**å¯¦éš›å¯¦ä½œ** (æœ¬å°ˆæ¡ˆ Phase 2):
```python
# core/event_bus.py
class EventBus:
    def publish(self, event_type, data):
        # éåŒæ­¥é€šçŸ¥æ‰€æœ‰è¨‚é–±è€…
        for callback in self.subscribers[event_type]:
            callback(data)

# modules/nlp_module/nlp_module.py
def handle(self, input):
    result = self._analyze(input)
    # ç™¼å¸ƒäº‹ä»¶ï¼Œç„¡éœ€çŸ¥é“èª°è¨‚é–±
    event_bus.publish(SystemEvent.INPUT_LAYER_COMPLETE, result)
```

**è©•åˆ†**:
| é™åˆ¶ | å¾—åˆ† | èªªæ˜ |
|:---|:---:|:---|
| æ¨¡çµ„é¬†è€¦åˆ | 10/10 | â­ å®Œå…¨è§£è€¦ |
| æ¸¬è©¦æ€§ | 9/10 | â­ æ˜“æ–¼å–®å…ƒæ¸¬è©¦ |
| è™•ç†å»¶é² | 6/10 | äº‹ä»¶é€šè¨Šæœ‰é–‹éŠ· |
| è¨˜æ†¶é«”ä½¿ç”¨ | 6/10 | Event Bus ä½”ç”¨é¡å¤–è¨˜æ†¶é«” |
| å¯æ“´å±•æ€§ | 10/10 | â­ å‹•æ…‹æ–°å¢æ¨¡çµ„ |
| éŒ¯èª¤æ¢å¾© | 9/10 | â­ éŒ¯èª¤éš”é›¢ |
| é…ç½®éˆæ´»æ€§ | 8/10 | æ¨¡çµ„èˆ‡äº‹ä»¶çš†å¯é…ç½® |
| **ç¸½åˆ†** | **58/80** | |

---

### 1.4.3 æ¯”è¼ƒç¸½è¡¨

| è©•ä¼°é …ç›® | æ–¹æ¡ˆ A<br>(Monolithic) | æ–¹æ¡ˆ B<br>(Direct Call) | æ–¹æ¡ˆ C<br>(Event-Driven) âœ… |
|:---|:---:|:---:|:---:|
| **é–‹ç™¼è¤‡é›œåº¦** | ä½ | ä¸­ | é«˜ |
| **ç¶­è­·æˆæœ¬** | é«˜ | ä¸­ | ä½ |
| **æ¨¡çµ„é¬†è€¦åˆ** | âŒ å·® | âš ï¸ ä¸­ | âœ… å„ª |
| **æ¸¬è©¦æ€§** | âŒ å·® | âš ï¸ ä¸­ | âœ… å„ª |
| **å¯æ“´å±•æ€§** | âŒ å·® | âš ï¸ ä¸­ | âœ… å„ª |
| **éŒ¯èª¤æ¢å¾©** | âŒ å·® | âš ï¸ ä¸­ | âœ… å„ª |
| **è™•ç†å»¶é²** | âœ… å„ª | âœ… å„ª | âš ï¸ ä¸­ |
| **è¨˜æ†¶é«”ä½¿ç”¨** | âœ… å„ª | âœ… å„ª | âš ï¸ ä¸­ |
| **ç¸½åˆ†** | 29/80 | 41/80 | **58/80** |
| **é©ç”¨å ´æ™¯** | å°å‹åŸå‹ | ä¸­å‹å°ˆæ¡ˆ | å¤§å‹æ¨¡çµ„åŒ–ç³»çµ± |

---

## 1.5 é¸æ“‡æ–¹æ¡ˆèªªæ˜ (Selected Solution Rationale)

### 1.5.1 é¸æ“‡çµè«–

ç¶“éè©³ç´°åˆ†æï¼Œæœ¬å°ˆæ¡ˆé¸æ“‡ **æ–¹æ¡ˆ C: Event-Driven Architecture (äº‹ä»¶é©…å‹•æ¶æ§‹)**ã€‚

### 1.5.2 é¸æ“‡ç†ç”±

#### 1. ç¬¦åˆé•·æœŸç™¼å±•éœ€æ±‚
U.E.P å°ˆæ¡ˆé è¨ˆæŒçºŒè¿­ä»£ï¼Œéœ€è¦é »ç¹æ–°å¢æ¨¡çµ„ (å¦‚ Frontend Adapterã€æ›´å¤šå·¥ä½œæµé¡å‹)ã€‚äº‹ä»¶é©…å‹•æ¶æ§‹å…è¨±ç„¡ä¾µå…¥å¼æ“´å±•ï¼Œé¿å…ã€Œæ”¹å‹•ä¸€è™•ï¼Œå½±éŸ¿å…¨å±€ã€çš„æŠ€è¡“å‚µã€‚

#### 2. æ”¯æ´è¤‡é›œå”ä½œæ¨¡å¼
ç³»çµ±éœ€è¦æ”¯æ´å¤šç¨®æ¨¡çµ„çµ„åˆï¼š
- **CHAT æ¨¡å¼**: STT â†’ NLP â†’ MEM + LLM â†’ TTS
- **WORK æ¨¡å¼**: STT â†’ NLP â†’ LLM + SYS â†’ TTS
- **æœªä¾†æ¨¡å¼**: å¯èƒ½æœ‰æ›´å¤šçµ„åˆ

äº‹ä»¶é©…å‹•æ¶æ§‹é€é `Module Coordinator` å‹•æ…‹é¸æ“‡æ¨¡çµ„ï¼Œç„¡éœ€ä¿®æ”¹æ ¸å¿ƒç¨‹å¼ç¢¼ã€‚

#### 3. éŒ¯èª¤éš”é›¢è‡³é—œé‡è¦
AI ç³»çµ±å„æ¨¡çµ„ (STTã€LLMã€TTS) çš†å¯èƒ½å¤±æ•—ã€‚äº‹ä»¶é©…å‹•æ¶æ§‹ç¢ºä¿ï¼š
- STT éŒ¯èª¤ â†’ åƒ…å½±éŸ¿æœ¬æ¬¡è¼¸å…¥é€±æœŸ
- LLM è¶…æ™‚ â†’ ä¸é˜»å¡å…¶ä»–æ¨¡çµ„
- TTS å¤±æ•— â†’ ç³»çµ±å¯é™ç´šç‚ºæ–‡å­—è¼¸å‡º

#### 4. æ¸¬è©¦æ€§æå‡é–‹ç™¼æ•ˆç‡
æ¯å€‹æ¨¡çµ„å¯ç¨ç«‹æ¸¬è©¦ï¼Œç„¡éœ€å•Ÿå‹•æ•´å€‹ç³»çµ±ï¼š
```python
# å–®å…ƒæ¸¬è©¦ç¯„ä¾‹
def test_nlp_module():
    nlp = NLPModule()
    result = nlp.handle({"text": "Hello"})
    assert result.primary_intent == IntentType.CHAT
```

#### 5. å‰ç«¯æ•´åˆæ›´éˆæ´»
å³å°‡å¯¦ç¾çš„ Frontend Adapter éœ€è¦ç›£è½å¤šç¨®å¾Œç«¯äº‹ä»¶ï¼š
- `PROCESSING_LAYER_COMPLETE` â†’ æ›´æ–°å‹•ç•«ç‹€æ…‹
- `OUTPUT_LAYER_COMPLETE` â†’ åŒæ­¥å£å‹å‹•ç•«
- `SESSION_ENDED` â†’ é‡ç½® UI

äº‹ä»¶é©…å‹•æ¶æ§‹è®“å‰ç«¯ç„¡éœ€ä¿®æ”¹å¾Œç«¯ç¨‹å¼ç¢¼å³å¯ç²å–æ‰€æœ‰å¿…è¦äº‹ä»¶ã€‚

### 1.5.3 å…‹æœç¼ºé»çš„ç­–ç•¥

| ç¼ºé» | å…‹æœç­–ç•¥ | å¯¦ä½œè­‰æ“š |
|:---|:---|:---|
| **é™¤éŒ¯å›°é›£** | äº‹ä»¶æ­·å²è¿½è¹¤ | `event_bus.py`: ä¿ç•™æœ€è¿‘ 100 å€‹äº‹ä»¶ |
| **è™•ç†å»¶é²** | Flow-Based å»é‡ | `module_coordinator.py`: é˜²æ­¢é‡è¤‡è™•ç† |
| **å­¸ç¿’æ›²ç·šé™¡** | å®Œæ•´æ–‡ä»¶èˆ‡ç¯„ä¾‹ | æœ¬ SDD æ–‡ä»¶ã€`docs/äº‹ä»¶é©…å‹•æ¶æ§‹å¿«é€Ÿåƒè€ƒ.md` |
| **è¨˜æ†¶é«”é–‹éŠ·** | äº‹ä»¶ä½‡åˆ—é™åˆ¶ | Event Bus ä½¿ç”¨æœ‰ç•Œä½‡åˆ— |

### 1.5.4 Phase 1 â†’ Phase 2 é‡æ§‹è­‰æ˜

æœ¬å°ˆæ¡ˆå¯¦éš›å¾ Phase 1 (Direct Call) é‡æ§‹ç‚º Phase 2 (Event-Driven)ï¼Œé©—è­‰äº†æ¶æ§‹é¸æ“‡çš„æ­£ç¢ºæ€§ï¼š

**é‡æ§‹å‰å•é¡Œ**:
- æ–°å¢ SYS æ¨¡çµ„éœ€ä¿®æ”¹ Routerã€Controller ç­‰ 5+ å€‹æª”æ¡ˆ
- LLM æ¨¡çµ„æ¸¬è©¦éœ€è¦å•Ÿå‹• MEM æ¨¡çµ„
- ç‹€æ…‹è®Šæ›´å½±éŸ¿å¤šè™•ç¨‹å¼ç¢¼

**é‡æ§‹å¾Œæ”¹å–„**:
- æ–°å¢æ¨¡çµ„åƒ…éœ€å¯¦ä½œ `handle()` ä¸¦è¨‚é–±äº‹ä»¶
- æ¨¡çµ„å¯å®Œå…¨ç¨ç«‹æ¸¬è©¦
- ç‹€æ…‹è®Šæ›´é€éäº‹ä»¶è‡ªå‹•é€šçŸ¥ç›¸é—œæ¨¡çµ„

---

## 1.6 ä»‹é¢éœ€æ±‚èˆ‡è¨­è¨ˆ (Interface Requirements and Design)

### 1.6.1 ä»‹é¢è¨­è¨ˆæº–å‰‡ (Interface Design Criteria)

ä¾ç…§ç³»çµ±æ¶æ§‹ï¼Œæœ¬ç³»çµ±å°æ–¼ä»‹é¢è¨­è¨ˆçš„é™åˆ¶å¦‚ä¸‹ï¼š

| æº–å‰‡ ID | æº–å‰‡åç¨± | èªªæ˜ | ç´„æŸæ¢ä»¶ |
|:---:|:---|:---|:---|
| **IFC-001** | äº‹ä»¶æ¨™æº–åŒ– | æ‰€æœ‰äº‹ä»¶å¿…é ˆä½¿ç”¨ `SystemEvent` Enum | ç¦æ­¢ä½¿ç”¨å­—ä¸²äº‹ä»¶åç¨± |
| **IFC-002** | è³‡æ–™çµæ§‹åŒ– | æ¨¡çµ„è¼¸å…¥/è¼¸å‡ºå¿…é ˆä½¿ç”¨ Pydantic æ¨¡å‹ | å¼·åˆ¶å‹åˆ¥æª¢æŸ¥ |
| **IFC-003** | ç„¡ç‹€æ…‹æ¨¡çµ„ | æ¨¡çµ„ä¸æ‡‰ä¾è³´å…§éƒ¨ç‹€æ…‹ (é™¤é…ç½®å¤–) | ç‹€æ…‹å­˜æ–¼ Working Context |
| **IFC-004** | æœƒè©±æ„ŸçŸ¥ | æ‰€æœ‰äº‹ä»¶éœ€åŒ…å« `session_id` | æ”¯æ´æœƒè©±éš”é›¢ |
| **IFC-005** | å‘å¾Œç›¸å®¹ | æ–°å¢æ¬„ä½ä¸æ‡‰ç ´å£ç¾æœ‰æ¨¡çµ„ | ä½¿ç”¨ `Optional` æ¬„ä½ |
| **IFC-006** | éŒ¯èª¤é€æ˜åŒ– | æ¨¡çµ„éŒ¯èª¤å¿…é ˆé€éæ¨™æº–æ ¼å¼å›å ± | åŒ…å«éŒ¯èª¤ç¢¼èˆ‡è¨Šæ¯ |

### 1.6.2 æ ¸å¿ƒä»‹é¢è¨­è¨ˆ (Core Interface Designs)

#### 1.6.2.1 Event Bus Interface

**äº‹ä»¶é¡å‹å®šç¾©** (`core/schemas.py`):
```python
class SystemEvent(Enum):
    # å±¤ç´šå®Œæˆäº‹ä»¶
    INPUT_LAYER_COMPLETE = "input_layer_complete"
    PROCESSING_LAYER_COMPLETE = "processing_layer_complete"
    OUTPUT_LAYER_COMPLETE = "output_layer_complete"
    
    # é€±æœŸäº‹ä»¶
    CYCLE_COMPLETED = "cycle_completed"
    
    # æœƒè©±äº‹ä»¶
    SESSION_STARTED = "session_started"
    SESSION_ENDED = "session_ended"
    
    # å·¥ä½œæµäº‹ä»¶
    WORKFLOW_STEP_COMPLETED = "workflow_step_completed"
    WORKFLOW_FAILED = "workflow_failed"
    WORKFLOW_COMPLETED = "workflow_completed"
    
    # ç‹€æ…‹äº‹ä»¶
    STATE_CHANGED = "state_changed"
```

**äº‹ä»¶è³‡æ–™æ ¼å¼**:
```python
@dataclass
class EventData:
    session_id: str
    cycle_index: int
    timestamp: datetime
    source_module: str
    data: Dict[str, Any]
    metadata: Optional[Dict[str, Any]] = None
```

**è¨‚é–±/ç™¼å¸ƒä»‹é¢**:
```python
# è¨‚é–±äº‹ä»¶
event_bus.subscribe(SystemEvent.INPUT_LAYER_COMPLETE, callback)

# ç™¼å¸ƒäº‹ä»¶
event_bus.publish(
    SystemEvent.INPUT_LAYER_COMPLETE,
    EventData(
        session_id="gs_12345",
        cycle_index=3,
        timestamp=datetime.now(),
        source_module="nlp_module",
        data={"primary_intent": "CHAT", ...}
    )
)
```

#### 1.6.2.2 Module Interface

**æ¨™æº–æ¨¡çµ„ä»‹é¢** (`core/bases/base_module.py`):
```python
class BaseModule(ABC):
    @abstractmethod
    def handle(self, input_data: BaseModel) -> BaseModel:
        """
        æ¨¡çµ„è™•ç†å…¥å£
        
        Args:
            input_data: ç¬¦åˆæ¨¡çµ„ Input Schema çš„ Pydantic æ¨¡å‹
            
        Returns:
            ç¬¦åˆæ¨¡çµ„ Output Schema çš„ Pydantic æ¨¡å‹
        """
        pass
    
    @abstractmethod
    def get_name(self) -> str:
        """è¿”å›æ¨¡çµ„åç¨±"""
        pass
    
    @abstractmethod
    def get_capabilities(self) -> List[str]:
        """è¿”å›æ¨¡çµ„èƒ½åŠ›æ¸…å–®"""
        pass
```

**æ¨¡çµ„è¨»å†Šä»‹é¢**:
```python
def register() -> BaseModule:
    """
    æ¨¡çµ„è¨»å†Šå‡½æ•¸
    
    æ¯å€‹æ¨¡çµ„çš„ __init__.py å¿…é ˆæä¾›æ­¤å‡½æ•¸
    ä¾› Framework è‡ªå‹•ç™¼ç¾ä¸¦è¼‰å…¥æ¨¡çµ„
    """
    return ModuleInstance()
```

#### 1.6.2.3 Collaboration Channel Interface

**è³‡æ–™æä¾›è€…è¨»å†Š** (`llm_module.py` ç¯„ä¾‹):
```python
# LLM æ¨¡çµ„è¨»å†Šè³‡æ–™æä¾›è€…
working_context_manager.register_data_provider(
    channel_name="CHAT_MEM",
    provider_id="mem_module",
    data_type="memory_context",
    fetch_callback=lambda: mem_module.get_recent_memories()
)
```

**è³‡æ–™æ¶ˆè²»è€…å­˜å–**:
```python
# LLM æ¨¡çµ„å­˜å– MEM æä¾›çš„è³‡æ–™
memory_context = working_context_manager.get_channel_data(
    channel_name="CHAT_MEM",
    data_type="memory_context"
)
```

#### 1.6.2.4 Session Interface

**æœƒè©±ç®¡ç†ä»‹é¢** (`core/sessions/session_manager.py`):
```python
class SessionManager:
    def create_general_session(self) -> str:
        """å‰µå»º General Sessionï¼Œè¿”å› session_id"""
        pass
    
    def create_chatting_session(self, gs_id: str, identity_token: str) -> str:
        """å‰µå»º Chatting Session"""
        pass
    
    def create_workflow_session(self, gs_id: str, workflow_type: str) -> str:
        """å‰µå»º Workflow Session"""
        pass
    
    def get_current_session_id(self) -> Optional[str]:
        """ç²å–ç•¶å‰æ´»èºæœƒè©± ID"""
        pass
    
    def end_session(self, session_id: str) -> None:
        """çµæŸæŒ‡å®šæœƒè©±"""
        pass
```

#### 1.6.2.5 MCP Protocol Interface (LLM â†” SYS)

**å·¥å…·èª¿ç”¨è«‹æ±‚** (LLM â†’ SYS):
```python
@dataclass
class MCPRequest:
    tool_name: str
    arguments: Dict[str, Any]
    session_id: str
    request_id: str
```

**å·¥å…·èª¿ç”¨å›æ‡‰** (SYS â†’ LLM):
```python
@dataclass
class MCPResponse:
    request_id: str
    success: bool
    result: Optional[Dict[str, Any]]
    error: Optional[str]
```

**å·¥å…·è¨»å†Š** (`sys_module/functions.yaml`):
```yaml
start_workflow:
  description: "Start a new workflow"
  parameters:
    workflow_type:
      type: string
      required: true
      description: "Type of workflow to start"
    parameters:
      type: object
      required: false
      description: "Workflow-specific parameters"
```

#### 1.6.2.6 Frontend Adapter Interface (å³å°‡å¯¦ç¾)

**å¾Œç«¯ â†’ å‰ç«¯äº‹ä»¶**:
```python
@dataclass
class FrontendEvent:
    event_type: FrontendEventType  # {STATE_CHANGE, TTS_START, TTS_END, ...}
    data: Dict[str, Any]
    timestamp: datetime
```

**å‰ç«¯ â†’ å¾Œç«¯æŒ‡ä»¤**:
```python
@dataclass
class FrontendCommand:
    command_type: FrontendCommandType  # {PAUSE, RESUME, CANCEL_TTS, ...}
    parameters: Dict[str, Any]
```

**ç‹€æ…‹åŒæ­¥ä»‹é¢**:
```python
class FrontendAdapter:
    def sync_system_state(self, state: UEPState) -> None:
        """åŒæ­¥ç³»çµ±ç‹€æ…‹åˆ°å‰ç«¯å‹•ç•«"""
        pass
    
    def sync_tts_playback(self, audio_progress: float) -> None:
        """åŒæ­¥ TTS æ’­æ”¾é€²åº¦åˆ°å£å‹å‹•ç•«"""
        pass
    
    def notify_processing_progress(self, layer: str, progress: float) -> None:
        """é€šçŸ¥è™•ç†å±¤é€²åº¦ (å¦‚ LLM ç”Ÿæˆé€²åº¦)"""
        pass
```

---

### 1.6.3 ä»‹é¢ç‰ˆæœ¬ç®¡ç† (Interface Versioning)

ç‚ºç¢ºä¿ç³»çµ±å¯æŒçºŒæ¼”é€²ï¼Œæ‰€æœ‰ä»‹é¢éµå¾ªä»¥ä¸‹ç‰ˆæœ¬è¦å‰‡ï¼š

| ç‰ˆæœ¬é¡å‹ | è®Šæ›´ç¯„åœ | å‘å¾Œç›¸å®¹æ€§ | ç¯„ä¾‹ |
|:---|:---|:---:|:---|
| **Major** (v2.0) | ç ´å£æ€§è®Šæ›´ | âŒ å¦ | æ”¹è®Šäº‹ä»¶è³‡æ–™çµæ§‹ |
| **Minor** (v2.1) | æ–°å¢åŠŸèƒ½ | âœ… æ˜¯ | æ–°å¢ Optional æ¬„ä½ |
| **Patch** (v2.1.1) | éŒ¯èª¤ä¿®æ­£ | âœ… æ˜¯ | ä¿®æ­£å‹åˆ¥æ¨™è¨» |

**ç•¶å‰ç‰ˆæœ¬**: v2.0 (Event-Driven Architecture)

---

### 1.6.4 ä»‹é¢æ¸¬è©¦ç­–ç•¥ (Interface Testing Strategy)

æ¯å€‹ä»‹é¢éœ€æä¾›ä»¥ä¸‹æ¸¬è©¦ï¼š

1. **å–®å…ƒæ¸¬è©¦**: é©—è­‰ä»‹é¢å®šç¾©æ­£ç¢ºæ€§
2. **æ•´åˆæ¸¬è©¦**: é©—è­‰æ¨¡çµ„é–“ä»‹é¢å¥‘ç´„
3. **å‘å¾Œç›¸å®¹æ¸¬è©¦**: é©—è­‰æ–°ç‰ˆæœ¬ä¸ç ´å£èˆŠç‰ˆæœ¬

**æ¸¬è©¦ç¯„ä¾‹** (`tests/test_event_bus_interface.py`):
```python
def test_event_subscription():
    """æ¸¬è©¦äº‹ä»¶è¨‚é–±ä»‹é¢"""
    received_events = []
    
    def callback(event_data):
        received_events.append(event_data)
    
    event_bus.subscribe(SystemEvent.INPUT_LAYER_COMPLETE, callback)
    event_bus.publish(
        SystemEvent.INPUT_LAYER_COMPLETE,
        EventData(session_id="test", cycle_index=1, ...)
    )
    
    assert len(received_events) == 1
    assert received_events[0].session_id == "test"
```

---

## ç¸½çµ (Summary)

æœ¬ç« ç¯€èªªæ˜äº† U.E.P ç³»çµ±çš„æ•´é«”æ¶æ§‹è¨­è¨ˆï¼ŒåŒ…æ‹¬ï¼š

âœ… **ç³»çµ±æ¶æ§‹æ¦‚è¦½**: ä¸‰å±¤äº‹ä»¶é©…å‹•æ¶æ§‹ï¼Œé€é Event Bus å¯¦ç¾é¬†è€¦åˆ  
âœ… **å­ç³»çµ±åŠŸèƒ½èˆ‡ä»‹é¢**: 11 å€‹æ ¸å¿ƒå­ç³»çµ± + 7 å€‹æ¨¡çµ„ + å‰ç«¯æ•´åˆå±¤  
âœ… **æŠ€è¡“è§£æ±ºæ–¹æ¡ˆé™åˆ¶**: 8 é …é—œéµé™åˆ¶èˆ‡å„ªå…ˆç´šè©•ä¼°  
âœ… **æ¶æ§‹æ–¹æ¡ˆæ¯”è¼ƒ**: è©•ä¼° 3 ç¨®æ–¹æ¡ˆï¼Œé¸æ“‡äº‹ä»¶é©…å‹•æ¶æ§‹ (å¾—åˆ† 58/80)  
âœ… **é¸æ“‡æ–¹æ¡ˆèªªæ˜**: è©³è¿°é¸æ“‡ç†ç”±èˆ‡å…‹æœç¼ºé»çš„ç­–ç•¥  
âœ… **ä»‹é¢éœ€æ±‚èˆ‡è¨­è¨ˆ**: å®šç¾© 6 å¤§æ ¸å¿ƒä»‹é¢èˆ‡ç‰ˆæœ¬ç®¡ç†ç­–ç•¥  

ä¸‹ä¸€ç« å°‡æ·±å…¥æ¢è¨ [æ ¸å¿ƒå­ç³»çµ±æ¶æ§‹](./02_æ ¸å¿ƒå­ç³»çµ±.md)ï¼ŒåŒ…æ‹¬ Controllerã€Frameworkã€Event Busã€Module Coordinator ç­‰çš„è©³ç´°è¨­è¨ˆã€‚

---

[â†’ ä¸‹ä¸€ç« ï¼šæ ¸å¿ƒå­ç³»çµ±](./02_æ ¸å¿ƒå­ç³»çµ±.md)  
[â† è¿”å›ä¸»æ–‡ä»¶](../System%20Design%20Documentation.md)
