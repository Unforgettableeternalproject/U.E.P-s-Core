@startuml CD-13-TTSæ¨¡çµ„

' TTS æ¨¡çµ„é¡åˆ¥åœ–
' èªéŸ³è¼¸å‡ºå±¤æ¶æ§‹

skinparam classAttributeIconSize 0
skinparam class {
    BackgroundColor<<module>> LightGreen
    BackgroundColor<<engine>> PaleGreen
    BorderColor DarkGreen
}

package "TTS æ¨¡çµ„ (Text-to-Speech Module)" {
    
    class TTSModule <<module>> {
        ' TTS ä¸»æ¨¡çµ„
        - tts_engine: TTSEngine
        - audio_player: AudioPlayer
        - output_queue: Queue
        - emotion_controller: EmotionController
        - config: Dict
        --
        + initialize(): bool
        + handle(input_data): ModuleResponse
        - _synthesize_speech(text, emotion): bytes
        - _play_audio(audio_data): void
        - _chunk_text(text): List[str]
        + shutdown(): void
    }
    
    class TTSEngine <<engine>> {
        ' TTS åˆæˆå¼•æ“
        - model: TTSModel
        - model_path: str
        - device: str
        - speaker_id: int
        --
        + load_model(model_path): void
        + synthesize(text, speaker_id, emotion): bytes
        + get_available_speakers(): List[int]
        + set_speed(speed): void
    }
    
    class AudioPlayer <<engine>> {
        ' éŸ³é »æ’­æ”¾å™¨
        - audio_device: Device
        - is_playing: bool
        - volume: float
        --
        + play(audio_data): void
        + stop(): void
        + pause(): void
        + resume(): void
        + set_volume(vol): void
    }
    
    class EmotionController {
        ' æƒ…æ„Ÿæ§åˆ¶å™¨
        - emotion_mappings: Dict[str, EmotionParams]
        - current_emotion: str
        --
        + set_emotion(emotion): void
        + get_emotion_params(emotion): EmotionParams
        + reset_to_neutral(): void
        + interpolate_emotions(from, to, factor): EmotionParams
    }
    
    class EmotionParams {
        ' æƒ…æ„Ÿåƒæ•¸
        + pitch: float
        + speed: float
        + energy: float
        + emotion_name: str
        --
        + to_dict(): Dict
        + from_dict(data): EmotionParams
    }
    
    enum EmotionType {
        ' æƒ…æ„Ÿé¡å‹
        NEUTRAL
        HAPPY
        SAD
        ANGRY
        EXCITED
        CALM
    }
}

' é—œä¿‚å®šç¾©
TTSModule "1" --> "1" TTSEngine : uses
TTSModule "1" --> "1" AudioPlayer : uses
TTSModule "1" --> "1" EmotionController : uses
EmotionController --> EmotionParams : manages
EmotionParams --> EmotionType : categorized by

' æ³¨é‡‹
note right of TTSModule
  **TTS ä¸»æ¨¡çµ„è·è²¬**
  
  1. æ–‡å­—åˆæˆèªéŸ³
  2. æƒ…æ„Ÿæ§åˆ¶
  3. éŸ³é »æ’­æ”¾
  4. æ–‡å­—åˆ†å¡Š
  
  è™•ç†æµç¨‹:
  1. æ¥æ”¶ LLM è¼¸å‡ºæ–‡å­—
  2. æª¢æ¸¬æƒ…æ„Ÿæ¨™è¨˜
  3. æ–‡å­—åˆ†å¡Š (é•·æ–‡)
  4. TTS å¼•æ“åˆæˆ
  5. éŸ³é »æ’­æ”¾
  6. ç™¼å¸ƒ OUTPUT_LAYER_COMPLETE
  
  å„ªåŒ–:
  - æµå¼åˆæˆ (é€å¥)
  - éŸ³é »å¿«å–
  - èƒŒæ™¯æ’­æ”¾
end note

note right of TTSEngine
  **TTS åˆæˆå¼•æ“**
  
  æ¨¡å‹é¸é …:
  - IndexTTS (æ¨è–¦)
  - VITS
  - GPT-SoVITS
  
  åˆæˆåƒæ•¸:
  - speaker_id: èªªè©±äºº ID
  - pitch: éŸ³èª¿ (-12 ~ +12)
  - speed: èªé€Ÿ (0.5 ~ 2.0)
  - energy: èƒ½é‡/éŸ³é‡
  
  æ”¯æ´:
  - GPU åŠ é€Ÿ (CUDA)
  - å¤šèªªè©±äºº
  - æƒ…æ„Ÿæ§åˆ¶
  - å¯¦æ™‚åˆæˆ
  
  è¼¸å‡ºæ ¼å¼:
  - WAV (16kHz, 16bit)
  - å­˜å„²åˆ° outputs/tts/
end note

note right of AudioPlayer
  **éŸ³é »æ’­æ”¾å™¨**
  
  ä½¿ç”¨åº«:
  - sounddevice (è·¨å¹³å°)
  - pyaudio (å‚™é¸)
  
  åŠŸèƒ½:
  - æ’­æ”¾ WAV/MP3
  - éŸ³é‡æ§åˆ¶
  - æ’­æ”¾æ§åˆ¶ (æ’­æ”¾/æš«åœ/åœæ­¢)
  
  éé˜»å¡æ’­æ”¾:
  - ä½¿ç”¨ threading
  - æ’­æ”¾å®Œæˆå›èª¿
  
  è¨­å‚™é¸æ“‡:
  - åˆ—å‡ºå¯ç”¨è¨­å‚™
  - é»˜èªè¼¸å‡ºè¨­å‚™
end note

note right of EmotionController
  **æƒ…æ„Ÿæ§åˆ¶æ©Ÿåˆ¶**
  
  æƒ…æ„Ÿæ˜ å°„:
  NEUTRAL:  {pitch: 0, speed: 1.0, energy: 1.0}
  HAPPY:    {pitch: +3, speed: 1.1, energy: 1.2}
  SAD:      {pitch: -2, speed: 0.9, energy: 0.8}
  ANGRY:    {pitch: +1, speed: 1.2, energy: 1.3}
  EXCITED:  {pitch: +5, speed: 1.3, energy: 1.4}
  CALM:     {pitch: -1, speed: 0.8, energy: 0.9}
  
  æª¢æ¸¬æ–¹å¼:
  - LLM è¼¸å‡ºåŒ…å«è¡¨æƒ…ç¬¦è™Ÿ
  - æ–‡å­—æƒ…æ„Ÿåˆ†æ
  - æ˜ç¢ºæ¨™è¨˜ [emotion:happy]
  
  éæ¸¡:
  - æƒ…æ„Ÿæ¼¸è®Š (interpolation)
  - é¿å…çªå…€åˆ‡æ›
end note

note bottom of EmotionParams
  **æƒ…æ„Ÿåƒæ•¸ç¯„ä¾‹**
  
  æª¢æ¸¬åˆ° ğŸ˜Š è¡¨æƒ…:
  {
    "emotion_name": "HAPPY",
    "pitch": +3.0,
    "speed": 1.1,
    "energy": 1.2
  }
  
  æ‡‰ç”¨åˆ° TTS:
  - éŸ³èª¿æé«˜ 3 åŠéŸ³
  - èªé€ŸåŠ å¿« 10%
  - éŸ³é‡å¢åŠ  20%
  
  çµæœ: é–‹å¿ƒçš„èªæ°£
end note

@enduml
