# äº‹ä»¶é©…å‹•æ¶æ§‹å¿«é€Ÿåƒè€ƒæŒ‡å—

**æ›´æ–°æ—¥æœŸ**: 2025-10-12  
**é©ç”¨ç¯„åœ**: æ‰€æœ‰æ–°é–‹ç™¼çš„æ¨¡çµ„å’ŒåŠŸèƒ½

---

## ğŸ“š ç›®éŒ„

1. [å¦‚ä½•ç™¼å¸ƒäº‹ä»¶](#å¦‚ä½•ç™¼å¸ƒäº‹ä»¶)
2. [å¦‚ä½•è¨‚é–±äº‹ä»¶](#å¦‚ä½•è¨‚é–±äº‹ä»¶)
3. [æ¨™æº–äº‹ä»¶é¡å‹](#æ¨™æº–äº‹ä»¶é¡å‹)
4. [æœ€ä½³å¯¦è¸](#æœ€ä½³å¯¦è¸)
5. [å¸¸è¦‹æ¨¡å¼](#å¸¸è¦‹æ¨¡å¼)
6. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## ğŸš€ å¦‚ä½•ç™¼å¸ƒäº‹ä»¶

### åŸºæœ¬ç”¨æ³•

```python
from core.event_bus import event_bus, SystemEvent

# ç™¼å¸ƒäº‹ä»¶
event_bus.publish(
    event_type=SystemEvent.INPUT_LAYER_COMPLETE,  # äº‹ä»¶é¡å‹
    data={                                        # äº‹ä»¶æ•¸æ“š
        "text": "ç”¨æˆ¶è¼¸å…¥",
        "intent": "chat"
    },
    source="nlp"                                  # ä¾†æºæ¨¡çµ„åç¨±
)
```

### åŒæ­¥ç™¼å¸ƒï¼ˆé˜»å¡ç›´åˆ°è™•ç†å®Œæˆï¼‰

```python
event_bus.publish(
    event_type=SystemEvent.MODULE_ERROR,
    data={"error": "æ¨¡çµ„åˆå§‹åŒ–å¤±æ•—"},
    source="my_module",
    sync=True  # åŒæ­¥æ¨¡å¼
)
```

---

## ğŸ“¡ å¦‚ä½•è¨‚é–±äº‹ä»¶

### åœ¨æ¨¡çµ„åˆå§‹åŒ–æ™‚è¨‚é–±

```python
class MyModule(BaseModule):
    def __init__(self):
        super().__init__()
        self._setup_event_subscriptions()
    
    def _setup_event_subscriptions(self):
        """è¨‚é–±éœ€è¦çš„äº‹ä»¶"""
        from core.event_bus import event_bus, SystemEvent
        
        event_bus.subscribe(
            SystemEvent.STATE_CHANGED,
            self._on_state_changed,
            handler_name="MyModule.state_changed"  # å¯é¸ï¼Œç”¨æ–¼æ—¥èªŒ
        )
    
    def _on_state_changed(self, event):
        """äº‹ä»¶è™•ç†å™¨"""
        new_state = event.data.get("new_state")
        print(f"ç³»çµ±ç‹€æ…‹æ”¹è®Šç‚º: {new_state}")
```

### å–æ¶ˆè¨‚é–±

```python
def cleanup(self):
    """æ¸…ç†æ™‚å–æ¶ˆè¨‚é–±"""
    from core.event_bus import event_bus, SystemEvent
    
    event_bus.unsubscribe(
        SystemEvent.STATE_CHANGED,
        self._on_state_changed
    )
```

---

## ğŸ“‹ æ¨™æº–äº‹ä»¶é¡å‹

### å±¤ç´šå®Œæˆäº‹ä»¶

```python
SystemEvent.INPUT_LAYER_COMPLETE        # NLP å®Œæˆè™•ç†
SystemEvent.PROCESSING_LAYER_COMPLETE   # LLM/MEM/SYS å®Œæˆè™•ç†
SystemEvent.OUTPUT_LAYER_COMPLETE       # TTS å®Œæˆè¼¸å‡º
```

**æ•¸æ“šæ ¼å¼ç¯„ä¾‹**:
```python
# INPUT_LAYER_COMPLETE
{
    "input_data": {...},
    "nlp_result": {...},
    "timestamp": 1234567890.0,
    "source_module": "nlp"
}

# PROCESSING_LAYER_COMPLETE
{
    "response": "å›æ‡‰æ–‡å­—",
    "source_module": "llm",
    "llm_output": {...},
    "mode": "chat",
    "success": True
}

# OUTPUT_LAYER_COMPLETE
{
    "tts_result": {...},
    "output_path": "/path/to/audio.wav",
    "duration": 2.5,
    "chunk_count": 3
}
```

### æ¨¡çµ„ç‹€æ…‹äº‹ä»¶

```python
SystemEvent.MODULE_INITIALIZED  # æ¨¡çµ„åˆå§‹åŒ–å®Œæˆ
SystemEvent.MODULE_READY       # æ¨¡çµ„å°±ç·’
SystemEvent.MODULE_ERROR       # æ¨¡çµ„éŒ¯èª¤
SystemEvent.MODULE_BUSY        # æ¨¡çµ„å¿™ç¢Œä¸­
```

### ç³»çµ±ç‹€æ…‹äº‹ä»¶

```python
SystemEvent.STATE_CHANGED      # ç³»çµ±ç‹€æ…‹æ”¹è®Š
SystemEvent.SESSION_STARTED    # æœƒè©±é–‹å§‹
SystemEvent.SESSION_ENDED      # æœƒè©±çµæŸ
```

### å¾ªç’°æ§åˆ¶äº‹ä»¶

```python
SystemEvent.CYCLE_STARTED      # è™•ç†å¾ªç’°é–‹å§‹
SystemEvent.CYCLE_COMPLETED    # è™•ç†å¾ªç’°å®Œæˆ
```

---

## âœ… æœ€ä½³å¯¦è¸

### 1. äº‹ä»¶å‘½åè¦ç¯„

```python
# âœ… å¥½çš„åšæ³•
event_bus.publish(
    SystemEvent.PROCESSING_LAYER_COMPLETE,
    data={
        "response": "...",
        "source_module": "llm",  # æ˜ç¢ºä¾†æº
        "timestamp": time.time()  # åŒ…å«æ™‚é–“æˆ³
    },
    source="llm"  # èˆ‡ source_module ä¸€è‡´
)

# âŒ é¿å…
event_bus.publish(
    SystemEvent.PROCESSING_LAYER_COMPLETE,
    data={"text": "..."},  # æ•¸æ“šä¸å®Œæ•´
    source="unknown"       # ä¾†æºä¸æ˜ç¢º
)
```

### 2. éŒ¯èª¤è™•ç†

```python
def _on_event(self, event):
    """äº‹ä»¶è™•ç†å™¨æ‡‰è©²æœ‰éŒ¯èª¤è™•ç†"""
    try:
        # è™•ç†é‚è¼¯
        result = self.process(event.data)
    except Exception as e:
        error_log(f"[MyModule] è™•ç†äº‹ä»¶å¤±æ•—: {e}")
        # ä¸è¦è®“ç•°å¸¸å‚³æ’­ï¼Œé¿å…å½±éŸ¿å…¶ä»–è¨‚é–±è€…
```

### 3. ç•°æ­¥è™•ç†

```python
# âœ… æ¨è–¦ï¼šç•°æ­¥ç™¼å¸ƒï¼ˆä¸é˜»å¡ï¼‰
event_bus.publish(
    SystemEvent.INPUT_LAYER_COMPLETE,
    data=completion_data,
    source="nlp"
)

# âš ï¸ è¬¹æ…ä½¿ç”¨ï¼šåŒæ­¥ç™¼å¸ƒï¼ˆæœƒé˜»å¡ï¼‰
event_bus.publish(
    SystemEvent.MODULE_ERROR,
    data=error_data,
    source="my_module",
    sync=True  # åƒ…åœ¨éœ€è¦ç¢ºä¿ç«‹å³è™•ç†æ™‚ä½¿ç”¨
)
```

### 4. æ•¸æ“šå®Œæ•´æ€§

```python
# âœ… æä¾›å®Œæ•´æ•¸æ“š
event_bus.publish(
    SystemEvent.PROCESSING_LAYER_COMPLETE,
    data={
        "response": response_text,
        "source_module": "llm",
        "llm_output": full_output,
        "timestamp": time.time(),
        "mode": "chat",
        "success": True,
        "metadata": {
            "processing_time": 1.5,
            "tokens_used": 150
        }
    },
    source="llm"
)
```

---

## ğŸ¯ å¸¸è¦‹æ¨¡å¼

### æ¨¡å¼ 1: å±¤ç´šå®Œæˆé€šçŸ¥

```python
class MyProcessingModule(BaseModule):
    def handle(self, data: dict) -> dict:
        # è™•ç†é‚è¼¯
        result = self.process(data)
        
        # âœ… è™•ç†å®Œæˆå¾Œç™¼å¸ƒäº‹ä»¶
        if result["success"]:
            self._notify_layer_completion(result)
        
        return result
    
    def _notify_layer_completion(self, result: Dict[str, Any]):
        """é€šçŸ¥å±¤ç´šå®Œæˆ"""
        from core.event_bus import event_bus, SystemEvent
        
        event_bus.publish(
            event_type=SystemEvent.PROCESSING_LAYER_COMPLETE,
            data={
                "response": result.get("text"),
                "source_module": "my_module",
                "output": result,
                "timestamp": time.time()
            },
            source="my_module"
        )
```

### æ¨¡å¼ 2: ç‹€æ…‹è®ŠåŒ–ç›£è½

```python
class StateAwareModule(BaseModule):
    def __init__(self):
        super().__init__()
        self.current_state = None
        self._setup_event_subscriptions()
    
    def _setup_event_subscriptions(self):
        from core.event_bus import event_bus, SystemEvent
        
        event_bus.subscribe(
            SystemEvent.STATE_CHANGED,
            self._on_state_changed
        )
    
    def _on_state_changed(self, event):
        """éŸ¿æ‡‰ç‹€æ…‹è®ŠåŒ–"""
        old_state = self.current_state
        new_state = event.data.get("new_state")
        
        self.current_state = new_state
        self._adapt_to_state(old_state, new_state)
```

### æ¨¡å¼ 3: éŒ¯èª¤å»£æ’­

```python
def handle_critical_error(self, error: Exception):
    """è™•ç†é—œéµéŒ¯èª¤ä¸¦å»£æ’­"""
    from core.event_bus import event_bus, SystemEvent
    
    error_log(f"[MyModule] é—œéµéŒ¯èª¤: {error}")
    
    # å»£æ’­éŒ¯èª¤äº‹ä»¶
    event_bus.publish(
        event_type=SystemEvent.MODULE_ERROR,
        data={
            "module": "my_module",
            "error_type": type(error).__name__,
            "error_message": str(error),
            "severity": "critical",
            "timestamp": time.time()
        },
        source="my_module",
        sync=True  # åŒæ­¥ç¢ºä¿éŒ¯èª¤è¢«è™•ç†
    )
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### å•é¡Œ 1: äº‹ä»¶æ²’æœ‰è¢«æ¥æ”¶

**æª¢æŸ¥æ¸…å–®**:
1. âœ… äº‹ä»¶ç¸½ç·šæ˜¯å¦å·²å•Ÿå‹•ï¼Ÿ
   ```python
   from core.event_bus import event_bus
   print(event_bus.get_stats())  # æª¢æŸ¥ is_running
   ```

2. âœ… è¨‚é–±æ˜¯å¦æˆåŠŸï¼Ÿ
   ```python
   stats = event_bus.get_stats()
   print(stats["subscribers"])  # æª¢æŸ¥è¨‚é–±è€…æ•¸é‡
   ```

3. âœ… äº‹ä»¶é¡å‹æ˜¯å¦æ­£ç¢ºï¼Ÿ
   ```python
   # ç¢ºä¿ç™¼å¸ƒå’Œè¨‚é–±ä½¿ç”¨ç›¸åŒçš„äº‹ä»¶é¡å‹
   event_bus.subscribe(SystemEvent.INPUT_LAYER_COMPLETE, handler)
   event_bus.publish(SystemEvent.INPUT_LAYER_COMPLETE, data, "test")
   ```

### å•é¡Œ 2: äº‹ä»¶è™•ç†å»¶é²

**å¯èƒ½åŸå› **:
- äº‹ä»¶éšŠåˆ—ç©å£“
- è™•ç†å™¨åŸ·è¡Œæ™‚é–“éé•·
- äº‹ä»¶ç¸½ç·šç·šç¨‹é˜»å¡

**è§£æ±ºæ–¹æ¡ˆ**:
```python
# æª¢æŸ¥éšŠåˆ—ç‹€æ…‹
stats = event_bus.get_stats()
if stats["queue_size"] > 10:
    print("âš ï¸ äº‹ä»¶éšŠåˆ—ç©å£“")

# æª¢æŸ¥è™•ç†çµ±è¨ˆ
if stats["processing_errors"] > 0:
    print("âš ï¸ æœ‰äº‹ä»¶è™•ç†éŒ¯èª¤")
```

### å•é¡Œ 3: äº‹ä»¶è™•ç†å™¨ç•°å¸¸

**æª¢æŸ¥äº‹ä»¶æ­·å²**:
```python
# æŸ¥çœ‹æœ€è¿‘çš„äº‹ä»¶
recent_events = event_bus.get_recent_events(count=10)
for event in recent_events:
    print(f"{event.event_type.value}: {event.source} @ {event.timestamp}")
```

**æª¢æŸ¥éŒ¯èª¤çµ±è¨ˆ**:
```python
stats = event_bus.get_stats()
print(f"è™•ç†éŒ¯èª¤: {stats['processing_errors']}")
```

---

## ğŸ§ª æ¸¬è©¦å»ºè­°

### å–®å…ƒæ¸¬è©¦ç¯„ä¾‹

```python
import unittest
from core.event_bus import EventBus, SystemEvent

class TestMyModule(unittest.TestCase):
    def setUp(self):
        self.bus = EventBus()
        self.bus.start()
    
    def tearDown(self):
        self.bus.stop()
    
    def test_event_publishing(self):
        """æ¸¬è©¦äº‹ä»¶ç™¼å¸ƒ"""
        received = []
        
        def handler(event):
            received.append(event)
        
        self.bus.subscribe(SystemEvent.MODULE_READY, handler)
        self.bus.publish(
            SystemEvent.MODULE_READY,
            {"module": "test"},
            "test"
        )
        
        import time
        time.sleep(0.5)
        
        self.assertEqual(len(received), 1)
```

---

## ğŸ“š æ›´å¤šè³‡æº

- ğŸ“„ [äº‹ä»¶é©…å‹•æ¶æ§‹é‡æ§‹ç¸½çµ](./äº‹ä»¶é©…å‹•æ¶æ§‹é‡æ§‹ç¸½çµ.md)
- ğŸ“„ [ä¸‰å±¤æ¶æ§‹å¯¦ç¾æ·±åº¦åˆ†æ](./ä¸‰å±¤æ¶æ§‹å¯¦ç¾æ·±åº¦åˆ†æ.md)
- ğŸ§ª [äº‹ä»¶ç¸½ç·šå–®å…ƒæ¸¬è©¦](../tests/test_event_bus.py)
- ğŸš€ [å¿«é€Ÿæ¸¬è©¦è…³æœ¬](../quick_test_event_bus.py)

---

## ğŸ¤ è²¢ç»æŒ‡å—

åœ¨é–‹ç™¼æ–°æ¨¡çµ„æ™‚ï¼š

1. **åœ¨ `__init__` ä¸­è¨‚é–±éœ€è¦çš„äº‹ä»¶**
2. **åœ¨é©ç•¶æ™‚æ©Ÿç™¼å¸ƒå®Œæˆäº‹ä»¶**
3. **ä½¿ç”¨æ¨™æº–äº‹ä»¶é¡å‹**
4. **æä¾›å®Œæ•´çš„äº‹ä»¶æ•¸æ“š**
5. **æ·»åŠ éŒ¯èª¤è™•ç†**
6. **ç·¨å¯«å–®å…ƒæ¸¬è©¦**

---

**Happy Event-Driven Coding! ğŸ‰**
