# 第六章:系統流程 (System Workflows)

[← 上一章:模組設計 - 輸出層](./05_模組設計_輸出層.md) | [返回主文件](../System%20Design%20Documentation.md)

---

## 6.1 系統啟動流程 (System Initialization)

### 6.1.1 啟動序列概覽

```
Entry.py 啟動
    ↓
System Initializer 執行 7 階段初始化
    ↓
System Loop 啟動主迴圈
    ↓
STT 持續監聽模式啟動
    ↓
系統就緒 (IDLE 狀態)
```

### 6.1.2 7 階段初始化流程

#### Phase 1: 核心元件 (Core Components)

**初始化順序**:
1. **Event Bus**: 事件通訊中樞
2. **State Manager**: 系統狀態機
3. **Router**: 文字路由器 (已棄用,保留相容性)

**特點**:
- 無依賴,最先啟動
- Event Bus 為後續所有元件提供通訊基礎
- State Manager 初始化為 IDLE 狀態

#### Phase 2: Framework (模組框架)

**初始化內容**:
- Framework 核心架構
- 模組註冊表初始化
- 效能監控系統

**依賴**: Event Bus

#### Phase 3: Router (路由器)

**初始化內容**:
- Router 配置載入
- 表情符號過濾規則
- 文字預處理管線

**注意**: Phase 3 已在 Phase 2 重構中逐步棄用,保留用於向後相容

#### Phase 4: Controller & Sessions

**初始化順序**:
1. **Session Manager**: 三層會話管理器
2. **Controller**: General Session 生命週期管理

**依賴**: Event Bus, State Manager

**功能**:
- Session Manager 初始化三層會話池 (GS/CS/WS)
- Controller 註冊 GS 生命週期事件處理器

#### Phase 5: Working Context

**初始化內容**:
- Working Context 管理器
- 協作通道註冊 (CHAT_MEM, WORK_SYS)
- TTL 自動清理機制啟動

**依賴**: 無額外依賴

#### Phase 6: 模組載入 (Module Discovery)

**自動發現機制**:
```
掃描 modules/ 目錄
    ↓
for each module in modules/:
    if __init__.py exists and has register():
        module_instance = register()
        framework.register_module(module_instance)
        module_instance.initialize()  # 模組初始化
        module_instance.health_check()  # 健康檢查
```

**載入順序** (按目錄字母排序):
1. `ani_module` (動畫引擎)
2. `llm_module` (LLM 整合)
3. `mem_module` (記憶管理)
4. `mov_module` (移動控制)
5. `nlp_module` (NLP 分析)
6. `stt_module` (語音轉文字)
7. `sys_module` (系統功能)
8. `tts_module` (語音合成)
9. `ui_module` (介面中樞)

**實際載入時間** (基於日誌數據):
| 模組 | 載入時間 | 備註 |
|:---|:---|:---|
| STT | ~8s | Whisper + Pyannote 模型載入 |
| TTS | ~35s | IndexTTS 模型載入 (最慢) |
| LLM | ~2s | Vertex AI 連線初始化 |
| MEM | ~1s | FAISS 索引載入 |
| 其他 | <1s | 輕量模組 |

#### Phase 7: 健康檢查與就緒

**健康檢查流程**:
```
for each module:
    result = module.health_check()
    if result.status != "healthy":
        log_warning(f"{module.name} health check failed")
        if result.critical:
            raise InitializationError()
```

**就緒確認**:
- 所有模組健康檢查通過
- Event Bus 訂閱者註冊完成
- System Loop 準備啟動

**總啟動時間**: ~37 秒 (主要受 TTS 模型載入影響)

### 6.1.3 啟動序列圖

```
┌─────────┐
│ Entry.py│
└────┬────┘
     │
     ├─> [Phase 1] Event Bus, State Manager, Router
     │        ↓
     ├─> [Phase 2] Framework
     │        ↓
     ├─> [Phase 3] Router (已棄用)
     │        ↓
     ├─> [Phase 4] Session Manager, Controller
     │        ↓
     ├─> [Phase 5] Working Context
     │        ↓
     ├─> [Phase 6] 模組自動發現與載入:
     │        ├─> ani_module.register()
     │        ├─> llm_module.register()
     │        ├─> mem_module.register()
     │        ├─> mov_module.register()
     │        ├─> nlp_module.register()
     │        ├─> stt_module.register() [~8s]
     │        ├─> sys_module.register()
     │        ├─> tts_module.register() [~35s]
     │        └─> ui_module.register()
     │        ↓
     ├─> [Phase 7] 健康檢查
     │        ├─> module.health_check() (all)
     │        └─> 系統就緒確認
     │        ↓
     └─> System Loop 啟動
              ↓
         STT 持續監聽啟動
              ↓
         系統進入 IDLE 狀態
```

---

## 6.2 System Loop 主迴圈 (Main Loop)

### 6.2.1 主迴圈架構

**設計理念**:
- System Loop 是系統的心跳
- 負責週期追蹤 (Cycle Index)
- 啟動 STT 持續監聽
- 發布 CYCLE_COMPLETED 事件

### 6.2.2 執行流程

```
[System Loop 啟動]
    ↓
cycle_index = 0
    ↓
啟動 STT 持續監聽
    ↓
┌─────────────────────────────────────┐
│        主迴圈 (Infinite Loop)        │
├─────────────────────────────────────┤
│                                     │
│  等待輸入 (STT 監聽中...)            │
│      ↓                              │
│  STT 偵測語音 → 轉文字 → 調用 NLP    │
│      ↓                              │
│  NLP 分析 → 發布 INPUT_LAYER_COMPLETE│
│      ↓                              │
│  Module Coordinator 協調處理層       │
│      ↓                              │
│  處理層完成 → 發布 PROCESSING_COMPLETE│
│      ↓                              │
│  Module Coordinator 協調輸出層       │
│      ↓                              │
│  輸出層完成 → 發布 OUTPUT_COMPLETE   │
│      ↓                              │
│  System Loop 發布 CYCLE_COMPLETED   │
│      ↓                              │
│  cycle_index += 1                  │
│      ↓                              │
│  返回迴圈頂部                        │
│                                     │
└─────────────────────────────────────┘
```

### 6.2.3 Cycle Index 追蹤機制

**用途**:
1. **Flow-Based Deduplication**: `{session_id}:{cycle_index}:{layer}` 組成去重鍵
2. **除錯追蹤**: 日誌記錄週期編號
3. **效能分析**: 計算每週期處理時間

**更新時機**:
- 每次 `CYCLE_COMPLETED` 事件後 `cycle_index += 1`
- GS 結束時重置為 0

**範例**:
```
Cycle 0: 用戶說 "你好" → 系統回應 "你好!" → CYCLE_COMPLETED
Cycle 1: 用戶說 "天氣如何?" → 系統回應 "..." → CYCLE_COMPLETED
Cycle 2: ...
```

---

## 6.3 CHAT 模式完整流程 (CHAT Mode Workflow)

### 6.3.1 流程概覽

```
用戶語音輸入
    ↓
輸入層 (STT → NLP) → INPUT_LAYER_COMPLETE
    ↓
處理層 (MEM → LLM) → PROCESSING_LAYER_COMPLETE
    ↓
輸出層 (TTS) → OUTPUT_LAYER_COMPLETE
    ↓
CYCLE_COMPLETED
```

### 6.3.2 CHAT 模式完整序列圖

```
┌────────┬──────┬──────┬──────────────┬─────┬─────┬─────┬─────┐
│ User   │ STT  │ NLP  │ Module Coord │ MEM │ LLM │ TTS │ Loop│
└───┬────┴──┬───┴──┬───┴──────┬───────┴──┬──┴──┬──┴──┬──┴──┬──┘
    │        │      │          │          │     │     │     │
[1] 語音輸入 │      │          │          │     │     │     │
    │───────>│      │          │          │     │     │     │
    │        │      │          │          │     │     │     │
[2] │   VAD 偵測   │          │          │     │     │     │
    │        │ + Whisper ASR  │          │     │     │     │
    │        │ + Pyannote ID  │          │     │     │     │
    │        │      │          │          │     │     │     │
[3] │    直接回調   │          │          │     │     │     │
    │        │─────>│          │          │     │     │     │
    │        │      │          │          │     │     │     │
[4] │        │  意圖分析       │          │     │     │     │
    │        │      │ (BIOS Tagger)       │     │     │     │
    │        │      │ primary_intent=CHAT │     │     │     │
    │        │      │          │          │     │     │     │
[5] │        │  狀態決策       │          │     │     │     │
    │        │      │ IDLE → CHAT         │     │     │     │
    │        │      │          │          │     │     │     │
[6] │        │ 發布事件         │          │     │     │     │
    │        │      │ INPUT_LAYER_COMPLETE│     │     │     │
    │        │      │─────────>│          │     │     │     │
    │        │      │          │          │     │     │     │
[7] │        │      │   創建 CS│          │     │     │     │
    │        │      │          │ (Chatting Session)   │     │
    │        │      │          │          │     │     │     │
[8] │        │      │   Flow 去重檢查      │     │     │     │
    │        │      │          │ dedupe_key =        │     │
    │        │      │          │ "gs_xxx:0:input" ✓  │     │
    │        │      │          │          │     │     │     │
[9] │        │      │  調用 MEM│          │     │     │     │
    │        │      │          │─────────>│     │     │     │
    │        │      │          │          │     │     │     │
[10]│        │      │          │ 語義檢索  │     │     │     │
    │        │      │          │   (FAISS)│     │     │     │
    │        │      │          │   + 快照查詢     │     │     │
    │        │      │          │          │     │     │     │
[11]│        │      │  Working Context     │     │     │     │
    │        │      │          │<─────────│     │     │     │
    │        │      │          │ CHAT_MEM = {    │     │     │
    │        │      │          │   summary: "..." │     │     │
    │        │      │          │   memories: [...] }   │     │
    │        │      │          │          │     │     │     │
[12]│        │      │  調用 LLM│          │     │     │     │
    │        │      │          │──────────────>│     │     │
    │        │      │          │          │     │     │     │
[13]│        │      │          │   Prompt 構建   │     │     │
    │        │      │          │     (System Role   │     │
    │        │      │          │      + CHAT_MEM    │     │
    │        │      │          │      + User Input) │     │
    │        │      │          │          │     │     │     │
[14]│        │      │          │   Gemini API    │     │     │
    │        │      │          │     + Context Cache│   │     │
    │        │      │          │          │     │     │     │
[15]│        │      │ 發布事件  │          │     │     │     │
    │        │      │          │ PROCESSING_LAYER_COMPLETE  │
    │        │      │          │<─────────────────│     │     │
    │        │      │          │          │     │     │     │
[16]│        │      │  調用 TTS│          │     │     │     │
    │        │      │          │──────────────────────>│     │
    │        │      │          │          │     │     │     │
[17]│        │      │          │   情感映射  │     │     │     │
    │        │      │          │   (Status → 8D) │     │     │
    │        │      │          │   + IndexTTS    │     │     │
    │        │      │          │   + 串流播放    │     │     │
    │        │      │          │          │     │     │     │
[18]│   語音輸出   │          │          │     │     │     │
    │<──────────────────────────────────────────────│     │
    │        │      │          │          │     │     │     │
[19]│        │      │ 發布事件  │          │     │     │     │
    │        │      │          │ OUTPUT_LAYER_COMPLETE      │
    │        │      │          │<───────────────────────│     │
    │        │      │          │          │     │     │     │
[20]│        │      │  發布事件│          │     │     │     │
    │        │      │          │ CYCLE_COMPLETED │     │     │
    │        │      │          │─────────────────────────>│  │
    │        │      │          │          │     │     │     │
[21]│        │      │          │   清理去重鍵     │     │     │
    │        │      │          │   cycle_index += 1     │  │
    │        │      │          │          │     │     │     │
```

### 6.3.3 關鍵決策點

#### 決策點 1: 意圖判斷 (NLP)
```
if primary_intent == IntentType.CHAT:
    next_modules = ["mem_module", "llm_module"]
    state_transition = IDLE → CHAT
```

#### 決策點 2: Session 創建 (Module Coordinator)
```
if current_state == IDLE and intent == CHAT:
    cs = session_manager.create_chatting_session(gs_id)
elif current_state == CHAT:
    cs = session_manager.get_current_chatting_session()
```

#### 決策點 3: Flow 去重 (Module Coordinator)
```
dedupe_key = f"{session_id}:{cycle_index}:processing"
if dedupe_key in processed_flows:
    return  # 跳過,已處理
processed_flows.add(dedupe_key)
```

### 6.3.4 Working Context 資料流

```
MEM Module 完成檢索
    ↓
記憶總結 (Memory Summarizer)
    ↓
Working Context 註冊:
working_context.register_data_provider(
    channel_id="CHAT_MEM",
    data={
        "summary": "用戶 Alice 喜歡藍色,上次對話提到...",
        "memories": [MemoryEntry(...), ...]
    }
)
    ↓
Module Coordinator 調用 LLM 時提取:
chat_mem_data = working_context.get_channel_data("CHAT_MEM")
    ↓
LLM Prompt 構建時嵌入記憶上下文
```

---

## 6.4 WORK 模式完整流程 (WORK Mode Workflow)

### 6.4.1 流程概覽

```
用戶語音輸入 (工作任務)
    ↓
輸入層 (STT → NLP) → WORK 意圖
    ↓
處理層 (LLM → MCP Client → SYS)
    ↓
Workflow Engine 執行 → Interactive Step
    ↓
LLM 審核 → 批准/修改
    ↓
工作流完成 → TTS 報告結果
```

### 6.4.2 WORK 模式完整序列圖

```
┌────┬───┬───┬──────────┬─────┬────────┬─────────────┬─────┬─────┐
│User│STT│NLP│Module Coord│LLM│MCP Cli│ SYS Workflow│Event│ TTS │
└─┬──┴─┬─┴─┬─┴────┬─────┴──┬──┴───┬────┴──────┬──────┴──┬──┴──┬──┘
  │    │   │      │        │      │           │         │     │
[1] 語音: "幫我歸檔這些檔案"│        │      │           │         │     │
  │───>│   │      │        │      │           │         │     │
  │    │   │      │        │      │           │         │     │
[2] STT 轉文字  │      │        │      │           │         │     │
  │    │──>│      │        │      │           │         │     │
  │    │   │      │        │      │           │         │     │
[3] 意圖分析    │      │        │      │           │         │     │
  │    │   │ primary_intent=WORK  │           │         │     │
  │    │   │      │        │      │           │         │     │
[4] 狀態決策    │      │        │      │           │         │     │
  │    │   │ IDLE → WORK  │      │           │         │     │
  │    │   │      │        │      │           │         │     │
[5] INPUT_LAYER_COMPLETE │        │      │           │         │     │
  │    │   │─────>│        │      │           │         │     │
  │    │   │      │        │      │           │         │     │
[6] 創建 WS     │        │      │           │         │     │
  │    │   │      │ (Workflow Session)│           │         │     │
  │    │   │      │        │      │           │         │     │
[7] 調用 LLM (WORK 模式)  │      │           │         │     │
  │    │   │      │───────>│      │           │         │     │
  │    │   │      │        │      │           │         │     │
[8] Prompt 構建 │        │      │           │         │     │
  │    │   │      │   (System Role    │           │         │     │
  │    │   │      │    + MCP Tools    │           │         │     │
  │    │   │      │    + User Task)   │           │         │     │
  │    │   │      │        │      │           │         │     │
[9] Gemini 返回 Function Call         │           │         │     │
  │    │   │      │        │ {          │           │         │     │
  │    │   │      │        │  name: "start_workflow"│         │     │
  │    │   │      │        │  args: {type: "archive_files"}   │     │
  │    │   │      │        │ }      │           │         │     │
  │    │   │      │        │      │           │         │     │
[10]MCP Client 解析並調用  │           │         │     │
  │    │   │      │        │─────>│           │         │     │
  │    │   │      │        │      │           │         │     │
[11]MCP Server 啟動工作流  │           │         │     │
  │    │   │      │        │      │──────────>│         │     │
  │    │   │      │        │      │           │         │     │
[12]Workflow Engine 執行   │           │         │     │
  │    │   │      │        │      │   Step 1: analyze_files│  │
  │    │   │      │        │      │   Step 2: generate_plan│  │
  │    │   │      │        │      │   Step 3: llm_review   │  │
  │    │   │      │        │      │           (Interactive)│  │
  │    │   │      │        │      │           │         │     │
[13]發布事件     │        │      │           │         │     │
  │    │   │      │        │      │ WORKFLOW_STEP_COMPLETED  │
  │    │   │      │        │      │           │────────>│     │
  │    │   │      │        │      │           │         │     │
[14]Working Context 更新   │           │         │     │
  │    │   │      │        │  WORK_SYS = {   │         │     │
  │    │   │      │        │    workflow_id: "wf_001"  │     │
  │    │   │      │        │    status: "WAITING_REVIEW"│     │
  │    │   │      │        │    review_data: {...}     │     │
  │    │   │      │        │  }     │           │         │     │
  │    │   │      │        │      │           │         │     │
[15]PROCESSING_LAYER_COMPLETE (部分)    │           │         │     │
  │    │   │      │<───────│      │           │         │     │
  │    │   │      │        │      │           │         │     │
[16]LLM 審核決策 │        │      │           │         │     │
  │    │   │      │───────>│      │           │         │     │
  │    │   │      │        │      │           │         │     │
[17]Gemini 分析 review_data│      │           │         │     │
  │    │   │      │        │ 決策: "批准"      │         │     │
  │    │   │      │        │      │           │         │     │
[18]MCP Client 調用 approve_step        │         │     │
  │    │   │      │        │─────>│           │         │     │
  │    │   │      │        │      │──────────>│         │     │
  │    │   │      │        │      │           │         │     │
[19]Workflow 繼續執行       │           │         │     │
  │    │   │      │        │      │   Step 4: move_files  │  │
  │    │   │      │        │      │   Step 5: create_summary│
  │    │   │      │        │      │           │         │     │
[20]Workflow 完成│        │      │           │         │     │
  │    │   │      │        │      │<──────────│         │     │
  │    │   │      │        │      │           │         │     │
[21]MCP Client 返回結果    │           │         │     │
  │    │   │      │        │<─────│           │         │     │
  │    │   │      │        │      │           │         │     │
[22]LLM 生成總結 │        │      │           │         │     │
  │    │   │      │        │ "已完成歸檔..."   │         │     │
  │    │   │      │        │      │           │         │     │
[23]PROCESSING_LAYER_COMPLETE           │         │     │
  │    │   │      │<───────│      │           │         │     │
  │    │   │      │        │      │           │         │     │
[24]調用 TTS     │        │      │           │         │     │
  │    │   │      │────────────────────────────────────────>│  │
  │    │   │      │        │      │           │         │     │
[25]語音輸出     │        │      │           │         │     │
  │<───────────────────────────────────────────────────────────│  │
  │    │   │      │        │      │           │         │     │
[26]CYCLE_COMPLETED         │      │           │         │     │
  │    │   │      │        │      │           │         │<────│  │
```

### 6.4.3 MCP Protocol 工具調用詳解

#### 可用 MCP 工具

| 工具名稱 | 功能 | 參數 | 返回 |
|:---|:---|:---|:---|
| `start_workflow` | 啟動工作流 | `type`, `params` | `workflow_id`, `requires_review`, `review_data` |
| `approve_step` | 批准步驟 | `workflow_id`, `step_id` | `success`, `next_step` |
| `modify_step` | 修改後批准 | `workflow_id`, `modifications` | `success`, `updated_plan` |
| `cancel_workflow` | 取消工作流 | `workflow_id` | `success` |
| `query_workflow_status` | 查詢狀態 | `workflow_id` | `status`, `current_step`, `progress` |
| `list_available_workflows` | 列出可用工作流 | - | `workflows[]` |

#### MCP 調用流程

```
LLM 生成 Function Call
    ↓
MCP Client 接收:
{
  "name": "start_workflow",
  "arguments": {
    "type": "archive_files",
    "params": {
      "files": ["/path/to/file1", "/path/to/file2"],
      "target_dir": "/archive"
    }
  }
}
    ↓
MCP Client 序列化參數
    ↓
調用 SYS Module MCP Server
    ↓
SYS Workflow Engine 執行
    ↓
返回結果 (JSON)
    ↓
MCP Client 反序列化
    ↓
返回給 LLM (Function Result)
    ↓
LLM 續寫生成最終響應
```

### 6.4.4 Workflow Engine 狀態機

```
┌────────────────────────────────────────┐
│      Workflow State Machine            │
├────────────────────────────────────────┤
│                                        │
│   READY                                │
│     ↓                                  │
│   EXECUTING (步驟循環)                  │
│     ├─> System Step (自動執行)         │
│     ├─> Processing Step (背景執行)     │
│     └─> Interactive Step (等待審核)    │
│           ↓                            │
│   WAITING_REVIEW                       │
│     ├─> approve_step → 繼續 EXECUTING  │
│     ├─> modify_step → 重試步驟         │
│     └─> cancel_workflow → CANCELLED    │
│           ↓                            │
│   COMPLETED                            │
│                                        │
│   異常路徑:                             │
│   EXECUTING → ERROR → FAILED           │
│   任何狀態 → timeout → CANCELLED        │
│                                        │
└────────────────────────────────────────┘
```

### 6.4.5 WORK_SYS 協作通道

```
SYS Workflow Engine 執行中
    ↓
Working Context 更新:
working_context.update_context(
    context_id="WORK_SYS",
    data={
        "workflow_id": "wf_001",
        "workflow_type": "archive_files",
        "current_step": "llm_review",
        "status": "WAITING_REVIEW",
        "review_data": {
            "analyzed_files": [...],
            "suggested_structure": {...},
            "confirmation_required": true
        }
    }
)
    ↓
LLM Module 消費 (WORK 模式 Prompt):
work_sys_data = working_context.get_channel_data("WORK_SYS")
    ↓
LLM 根據 review_data 生成決策:
- 批准歸檔計劃
- 修改目標目錄
- 取消工作流
```

---

## 6.5 事件驅動協作 (Event-Driven Collaboration)

### 6.5.1 事件發布/訂閱關係圖

```
┌────────────────────────────────────────────────────────────────┐
│                 Event Bus 發布/訂閱關係                         │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  事件類型                 發布者              訂閱者            │
│  ─────────────────────────────────────────────────────────    │
│                                                                │
│  INPUT_LAYER_COMPLETE     NLP Module         Module Coord     │
│                                                                │
│  PROCESSING_LAYER_COMPLETE LLM Module        Module Coord     │
│                                                                │
│  OUTPUT_LAYER_COMPLETE    TTS/UI Module      Module Coord     │
│                                                                │
│  CYCLE_COMPLETED          System Loop        Controller       │
│                                              Module Coord     │
│                                              Metrics          │
│                                                                │
│  GS_STARTED               Controller         All Modules      │
│                                                                │
│  GS_ENDED                 Controller         All Modules      │
│                                                                │
│  STATE_CHANGED            State Manager      All Modules      │
│                                                                │
│  SESSION_TIMEOUT          Session Manager    Controller       │
│                                                                │
│  WORKFLOW_STEP_COMPLETED  SYS Module         Event Bus        │
│                                              Working Context  │
│                                                                │
│  ERROR_OCCURRED           Any Module         Logger           │
│                                              Controller       │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 6.5.2 事件處理順序

#### CHAT 模式事件序列

```
1. INPUT_LAYER_COMPLETE
   ├─> Module Coordinator 處理
   └─> 調用 MEM + LLM

2. PROCESSING_LAYER_COMPLETE
   ├─> Module Coordinator 處理
   └─> 調用 TTS

3. OUTPUT_LAYER_COMPLETE
   ├─> Module Coordinator 處理
   └─> 通知 System Loop

4. CYCLE_COMPLETED
   ├─> Controller 檢查 GS 結束條件
   ├─> Module Coordinator 清理去重鍵
   └─> Metrics 記錄週期時間
```

#### WORK 模式事件序列

```
1. INPUT_LAYER_COMPLETE
   └─> Module Coordinator → 調用 LLM

2. WORKFLOW_STEP_COMPLETED (多次)
   └─> Working Context 更新 WORK_SYS

3. PROCESSING_LAYER_COMPLETE
   └─> Module Coordinator → 調用 TTS

4. OUTPUT_LAYER_COMPLETE
   └─> Module Coordinator → 通知 System Loop

5. CYCLE_COMPLETED
   └─> Controller + Metrics
```

### 6.5.3 Flow-Based Deduplication 機制

**去重鍵格式**:
```
dedupe_key = f"{session_id}:{cycle_index}:{layer}"
```

**範例**:
```
Cycle 0, Input Layer:  "gs_abc123:0:input"
Cycle 0, Processing:   "gs_abc123:0:processing"
Cycle 0, Output:       "gs_abc123:0:output"
Cycle 1, Input Layer:  "gs_abc123:1:input"
...
```

**去重檢查流程**:
```
Module Coordinator 接收 INPUT_LAYER_COMPLETE:
    ↓
生成 dedupe_key = "gs_abc123:0:input"
    ↓
檢查 processed_flows:
    ├─ 已存在? → return (跳過)
    └─ 不存在? → 添加到 processed_flows
        ↓
    繼續處理 (調用下一層模組)
```

**清理時機**:
```
CYCLE_COMPLETED 事件後:
    ↓
刪除當前 cycle 的所有去重鍵:
for key in list(processed_flows):
    if key.startswith(f"{session_id}:{current_cycle}:"):
        processed_flows.remove(key)
    ↓
cycle_index += 1
```

---

## 6.6 Session 生命週期 (Session Lifecycle)

### 6.6.1 三層 Session 架構

```
┌──────────────────────────────────────────────────┐
│           General Session (GS)                   │
│         生命週期: 啟動 → 結束                      │
├──────────────────────────────────────────────────┤
│                                                  │
│  ┌────────────────────┐  ┌──────────────────┐   │
│  │ Chatting Session   │  │ Workflow Session │   │
│  │      (CS)          │  │      (WS)        │   │
│  │                    │  │                  │   │
│  │ CHAT 模式子會話     │  │ WORK 模式子會話   │   │
│  │ 生命週期與 GS 綁定  │  │ 任務完成或超時    │   │
│  └────────────────────┘  └──────────────────┘   │
│                                                  │
└──────────────────────────────────────────────────┘
```

### 6.6.2 GS 生命週期狀態機

```
┌────────────────────────────────────────┐
│    General Session Lifecycle           │
├────────────────────────────────────────┤
│                                        │
│   [系統 IDLE]                          │
│        ↓                               │
│   檢測有效意圖 (CHAT/WORK)              │
│        ↓                               │
│   創建 GS                              │
│        ↓                               │
│   發布 GS_STARTED 事件                 │
│        ↓                               │
│   [GS 執行中]                          │
│     ├─> 創建 CS (CHAT 模式)            │
│     └─> 創建 WS (WORK 模式)            │
│        ↓                               │
│   等待結束條件:                         │
│     ├─ 自然結束 (OUTPUT_COMPLETE)      │
│     ├─ 超時 (SESSION_TIMEOUT)          │
│     └─ 錯誤 (ERROR_OCCURRED)           │
│        ↓                               │
│   發布 GS_ENDED 事件                   │
│        ↓                               │
│   清理資源                             │
│        ↓                               │
│   [系統回到 IDLE]                      │
│                                        │
└────────────────────────────────────────┘
```

### 6.6.3 GS 啟動條件

```python
def check_gs_start_conditions(nlp_output: NLPOutput) -> bool:
    """檢查 GS 啟動條件"""
    # 條件 1: 當前無活躍 GS
    if session_manager.has_active_gs():
        return False
    
    # 條件 2: 有效意圖 (CHAT 或 WORK)
    if nlp_output.primary_intent not in [IntentType.CHAT, IntentType.WORK]:
        return False
    
    # 條件 3: 系統狀態為 IDLE
    if state_manager.get_current_state() != UEPState.IDLE:
        return False
    
    return True
```

### 6.6.4 GS 結束條件 (雙條件終止)

**設計理念**:
- 確保不會在循環中間終止 GS
- 避免資源洩漏

**雙條件檢查**:
```python
def check_gs_end_conditions() -> bool:
    """檢查 GS 結束條件 (雙條件)"""
    
    # 條件 1: 外部中斷點
    external_interrupt = (
        output_layer_complete or   # 自然結束
        session_timeout or         # 超時
        error_occurred            # 錯誤
    )
    
    # 條件 2: 循環完成
    cycle_complete = (
        cycle_completed_event_received
    )
    
    # 雙條件同時滿足才結束
    return external_interrupt and cycle_complete
```

**結束流程**:
```
檢測到結束條件
    ↓
等待 CYCLE_COMPLETED 事件
    ↓
發布 GS_ENDED 事件
    ↓
清理子會話 (CS/WS)
    ↓
重置 cycle_index = 0
    ↓
系統回到 IDLE 狀態
```

### 6.6.5 CS/WS 生命週期

#### Chatting Session (CS)

**創建時機**:
```
Module Coordinator 接收 INPUT_LAYER_COMPLETE:
if primary_intent == CHAT and current_state == IDLE:
    cs = session_manager.create_chatting_session(gs_id)
elif current_state == CHAT:
    cs = session_manager.get_current_chatting_session()
```

**結束時機**:
- GS 結束時自動結束
- 狀態轉換至 WORK 時結束

#### Workflow Session (WS)

**創建時機**:
```
Module Coordinator 接收 INPUT_LAYER_COMPLETE:
if primary_intent == WORK:
    ws = session_manager.create_workflow_session(gs_id, workflow_type)
```

**結束時機**:
- 工作流完成 (COMPLETED)
- 工作流取消 (CANCELLED)
- 工作流失敗 (FAILED)
- 超時 (預設 10 分鐘)

### 6.6.6 超時管理

| Session 類型 | 預設超時 | 超時行為 |
|:---|:---|:---|
| General Session | 5 分鐘 | 發布 SESSION_TIMEOUT,強制結束 |
| Chatting Session | 與 GS 相同 | 隨 GS 結束 |
| Workflow Session | 10 分鐘 | 中斷工作流,記錄錯誤 |

**超時檢查機制**:
```
Session Manager 定時檢查 (每 10 秒):
for session in active_sessions:
    if now - session.last_active > session.timeout_seconds:
        event_bus.publish(
            SystemEvent.SESSION_TIMEOUT,
            EventData(session_id=session.id, ...)
        )
```

---

## 總結 (Summary)

本章節詳細說明了 U.E.P 系統的完整運作流程:

✅ **系統啟動**: 7 階段初始化,實際啟動時間 ~37 秒  
✅ **System Loop**: 週期追蹤,CYCLE_COMPLETED 事件機制  
✅ **CHAT 模式**: 完整序列圖,包含 MEM 記憶檢索與 CHAT_MEM 通道  
✅ **WORK 模式**: MCP Protocol 工具調用,Workflow Engine 狀態機  
✅ **事件驅動**: 完整的發布/訂閱關係,Flow-Based 去重機制  
✅ **Session 生命週期**: 三層架構,雙條件終止機制,超時管理  

這些流程共同構成 U.E.P 事件驅動架構的運作基礎,確保系統穩定可靠地處理用戶請求。

---

[← 上一章:模組設計 - 輸出層](./05_模組設計_輸出層.md) | [返回主文件](../System%20Design%20Documentation.md)