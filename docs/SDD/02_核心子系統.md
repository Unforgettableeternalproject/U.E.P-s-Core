# 第二章:核心子系統架構 (Core Subsystem Architecture)

[← 上一章:系統架構](./01_系統架構.md) | [返回主文件](../System%20Design%20Documentation.md) | [下一章:模組設計 - 輸入層 →](./03_模組設計_輸入層.md)

---

## 2.1 核心控制層概述 (Core Control Layer Overview)

核心控制層是 U.E.P 系統的指揮中樞,負責系統初始化、模組協調、事件通訊、狀態管理和會話生命週期控制。本章節說明各核心子系統的設計理念與核心功能。

### 2.1.1 核心子系統架構圖

```
┌─────────────────────────────────────────────────────────────────┐
│                    Core Control Layer                            │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              System Initializer (啟動編排)                │   │
│  │  Phase 1→2→3: 核心元件 → Phase 4→5: 模組載入 →          │   │
│  │  Phase 6→7: 健康檢查與就緒                               │   │
│  └──────────────────────────────────────────────────────────┘   │
│                            ↓                                      │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                  System Loop (主迴圈)                      │   │
│  │  STT 監聽 → NLP 分析 → 處理層 → 輸出層 → 週期完成         │   │
│  └──────────────────────────────────────────────────────────┘   │
│                            ↓                                      │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                    Event Bus (事件中樞)                     │ │
│  │       發布/訂閱通訊 │ 非同步處理 │ 事件歷史追蹤             │ │
│  └────────────────────────────────────────────────────────────┘ │
│                            ↓                                      │
│  ┌─────────────┬──────────────┬──────────────────────────────┐  │
│  │ Controller  │   Module     │    Working Context          │  │
│  │ (GS 管理)   │  Coordinator │    (協作通道)                │  │
│  │             │  (層級協調)   │                              │  │
│  ├─────────────┼──────────────┼──────────────────────────────┤  │
│  │  Sessions   │    States    │       Framework             │  │
│  │ (GS/CS/WS)  │  (狀態佇列)   │    (模組註冊)                │  │
│  └─────────────┴──────────────┴──────────────────────────────┘  │
└───────────────────────────────────────────────────────────────────┘
```

### 2.1.2 核心子系統清單

| 子系統 | 檔案位置 | 核心職責 |
|:---|:---|:---|
| **Event Bus** | `core/event_bus.py` | 事件通訊中樞 |
| **Module Coordinator** | `core/module_coordinator.py` | 模組協調與去重 |
| **Controller** | `core/controller.py` | General Session 生命週期管理 |
| **Framework** | `core/framework.py` | 模組註冊與效能監控 |
| **Session Manager** | `core/sessions/` | 三層會話管理 |
| **State Manager** | `core/states/` | 系統狀態機 |
| **Working Context** | `core/working_context.py` | 跨模組資料共享 |
| **System Initializer** | `core/system_initializer.py` | 系統啟動編排 |
| **System Loop** | `core/system_loop.py` | 主處理迴圈 |

---

## 2.2 Event Bus (事件匯流排)

**檔案位置**: `core/event_bus.py`

### 設計理念

Event Bus 是 U.E.P 事件驅動架構的核心,採用發布/訂閱模式實現模組間鬆耦合通訊。相較於直接函數調用,Event Bus 提供:

- **解耦合**: 發布者無需知道訂閱者身份
- **非同步處理**: 避免阻塞主流程
- **多訂閱者**: 一個事件可觸發多個處理器
- **除錯友好**: 事件歷史追蹤便於問題診斷

### 核心功能

1. **訂閱事件** (`subscribe`): 模組註冊事件處理器
2. **發布事件** (`publish`): 發送事件至所有訂閱者
3. **取消訂閱** (`unsubscribe`): 移除事件處理器
4. **事件歷史** (`get_event_history`): 查詢最近事件記錄

### 標準事件類型

| 事件類型 | 觸發時機 | 發布者 | 典型訂閱者 |
|:---|:---|:---|:---|
| `INPUT_LAYER_COMPLETE` | NLP 分析完成 | NLP Module | Module Coordinator |
| `PROCESSING_LAYER_COMPLETE` | 處理層完成 | LLM Module | Module Coordinator |
| `OUTPUT_LAYER_COMPLETE` | 輸出層完成 | TTS/UI Module | Module Coordinator |
| `CYCLE_COMPLETED` | 單個週期結束 | System Loop | Controller, Metrics |
| `GS_STARTED` | General Session 啟動 | Controller | All Modules |
| `GS_ENDED` | General Session 結束 | Controller | All Modules |
| `STATE_CHANGED` | 系統狀態轉換 | State Manager | All Modules |
| `ERROR_OCCURRED` | 錯誤發生 | Any Module | Logger, Controller |
| `SESSION_TIMEOUT` | 會話超時 | Session Manager | Controller |

### 事件資料結構

```python
@dataclass
class EventData:
    """事件資料封裝"""
    session_id: str                      # 會話 ID
    cycle_index: int                     # 週期索引
    timestamp: datetime                  # 時間戳
    source_module: str                   # 來源模組
    data: Dict[str, Any]                 # 事件資料
    metadata: Dict[str, Any] = field(default_factory=dict)
```

### 使用範例

```python
# 訂閱事件
event_bus.subscribe(
    SystemEvent.INPUT_LAYER_COMPLETE,
    module_coordinator.handle_input_complete
)

# 發布事件
event_bus.publish(
    SystemEvent.INPUT_LAYER_COMPLETE,
    EventData(
        session_id="gs_abc123",
        cycle_index=3,
        timestamp=datetime.now(),
        source_module="nlp_module",
        data={"primary_intent": "chat", "next_modules": ["mem_module", "llm_module"]}
    )
)
```

### 技術特性

- **Thread-Safe**: 使用 `threading.Lock` 保護訂閱者列表
- **事件歷史**: `deque(maxlen=100)` 限制記憶體使用
- **非同步處理**: 事件處理不阻塞發布者

---

## 2.3 Module Coordinator (模組協調器)

**檔案位置**: `core/module_coordinator.py`

### 設計理念

Module Coordinator 是三層架構的指揮官,負責:
- 監聽層級完成事件 (INPUT/PROCESSING/OUTPUT)
- 根據意圖選擇下一層模組
- 防止重複處理同一個流程 (Flow-Based Deduplication)
- 管理協作通道資料傳遞

### 核心功能

1. **層級轉換協調**: 監聽 `LAYER_COMPLETE` 事件,調用下一層模組
2. **模組選擇**: 根據意圖類型決定調用哪些模組
3. **Flow 去重**: 確保同一週期的同一層級只處理一次
4. **協作通道整合**: 從 Working Context 提取資料傳遞給模組

### Flow-Based Deduplication

**去重鍵格式**: `{session_id}:{cycle_index}:{layer}`

**範例**:
- `gs_abc123:3:input` (第 3 週期輸入層)
- `gs_abc123:3:processing` (第 3 週期處理層)
- `gs_abc123:3:output` (第 3 週期輸出層)

**清理時機**: 每個 `CYCLE_COMPLETED` 事件後清除當前週期的去重鍵

### 模組選擇決策

| 主要意圖 | 系統狀態 | 下一層模組 | 會話操作 |
|:---|:---|:---|:---|
| `CHAT` | `IDLE` | `mem_module`, `llm_module` | 創建 Chatting Session |
| `CHAT` | `CHAT` | `mem_module`, `llm_module` | 繼續 Chatting Session |
| `WORK` | `IDLE` | `llm_module` | 創建 Workflow Session |
| `WORK` | `WORK` | `llm_module` | 繼續 Workflow Session |
| `RESPONSE` | `WORK` | `llm_module` | 繼續 Workflow Session |

### 協作通道資料提供

Module Coordinator 從 Working Context 提取協作通道資料並傳遞給模組:

- **CHAT_MEM**: 記憶檢索結果 → LLM Module
- **WORK_SYS**: 工作流狀態 → LLM Module

```python
# 簡化示例
chat_mem_data = working_context.get_channel_data("CHAT_MEM")
llm_module.handle(LLMInput(
    text=user_text,
    chat_memory=chat_mem_data  # 傳遞協作資料
))
```

---

## 2.4 Controller (控制器)

**檔案位置**: `core/controller.py`

### 設計理念

Controller 管理 General Session (GS) 的完整生命週期,負責:
- 偵測 GS 啟動條件
- 偵測 GS 結束條件
- 發布 GS 生命週期事件
- 監控系統健康狀態

### 核心功能

1. **GS 啟動偵測**: 監聽 `INPUT_LAYER_COMPLETE`,檢查是否應創建 GS
2. **GS 結束偵測**: 監聽 `OUTPUT_LAYER_COMPLETE`,檢查是否應結束 GS
3. **健康監控**: 追蹤模組錯誤率、響應時間
4. **事件發布**: 發布 `GS_STARTED`、`GS_ENDED` 事件

### GS 生命週期

#### 啟動條件
- STT標註啟動 (使用者輸入時)
- 互動已經啟動 (由NLP辨識到CALL意圖時處理)
- 系統進入過至少一個非IDLE狀態
- 當前無活躍 GS

#### 結束條件
- **自然結束**: 當前狀態佇列中不存在IDLE外其他狀態，並且其他會話也結束時於該循環結束時結束
- **超時結束**: GS 存活時間超過配置閾值
- **錯誤結束**: 處理過程發生嚴重錯誤

### 健康監控指標

| 指標 | 說明 | 閾值 |
|:---|:---|:---|
| 模組錯誤率 | 單一模組錯誤次數/總調用次數 | > 10% 觸發告警 |
| 平均響應時間 | GS 啟動到結束的平均時間 | > 10s 記錄告警 |
| 會話超時率 | 超時結束的 GS 比例 | > 20% 觸發告警 |

---

## 2.5 Framework (框架)

**檔案位置**: `core/framework.py`

### 設計理念

Framework 負責模組的自動發現、註冊和效能監控,提供:
- 自動掃描 `modules/` 目錄
- 模組生命週期管理 (初始化、就緒檢查)
- 效能指標收集

### 核心功能

1. **模組自動發現**: 掃描 `modules/` 目錄,調用各模組的 `register()` 函數
2. **模組註冊**: 儲存模組實例至模組註冊表
3. **模組就緒檢查**: 初始化後驗證模組可用性
4. **效能監控**: 記錄每個模組的調用次數、執行時間

### 模組註冊流程

```
掃描 modules/ 目錄
    ↓
發現 __init__.py 中的 register() 函數
    ↓
調用 register() → 返回模組實例
    ↓
執行 module.initialize() (若有)
    ↓
執行 module.health_check() 驗證就緒
    ↓
加入模組註冊表 {module_name: module_instance}
```

### 效能指標結構

```python
@dataclass
class ModuleMetrics:
    """模組效能指標"""
    module_name: str
    total_calls: int = 0
    total_time: float = 0.0
    error_count: int = 0
    avg_time: float = 0.0
```

---

## 2.6 Session Manager (會話管理器)

**檔案位置**: `core/sessions/session_manager.py`

### 設計理念

Session Manager 實現三層會話架構:
- **General Session (GS)**: 完整互動會話 (啟動到結束)
- **Chatting Session (CS)**: 對話模式子會話 (記憶檢索 + 對話生成)
- **Workflow Session (WS)**: 工作流模式子會話 (多步驟任務執行)

### 三層會話架構

```
General Session (gs_abc123)
    ├── Chatting Session (cs_xyz001)  [CHAT 模式]
    │   └── 生命週期: GS 內多輪對話
    │
    └── Workflow Session (ws_task456) [WORK 模式]
        └── 生命週期: 任務完成或超時
```

### 會話資料結構

```python
@dataclass
class SessionInfo:
    """會話資訊"""
    session_id: str
    session_type: SessionType  # GENERAL | CHATTING | WORKFLOW
    parent_session_id: Optional[str] = None
    created_at: datetime = field(default_factory=datetime.now)
    last_active: datetime = field(default_factory=datetime.now)
    timeout_seconds: int = 300
    metadata: Dict[str, Any] = field(default_factory=dict)
```

### 超時管理

| 會話類型 | 預設超時 | 超時行為 |
|:---|:---|:---|
| General Session | 5 分鐘 | 發布 `SESSION_TIMEOUT` 事件,強制結束 |
| Chatting Session | 與 GS 相同 | 隨 GS 結束而結束 |
| Workflow Session | 10 分鐘 | 任務未完成時中斷,記錄錯誤 |

---

## 2.7 State Manager (狀態管理器)

**檔案位置**: `core/states/state_manager.py`

### 設計理念

State Manager 管理系統狀態機,確保:
- 狀態轉換的唯一決策權在 NLP Module
- 狀態佇列支援優先級排序
- 狀態轉換事件通知所有模組

### 系統狀態定義

```python
class UEPState(Enum):
    """系統狀態"""
    IDLE = "idle"          # 空閒 (等待輸入)
    CHAT = "chat"          # 對話模式
    WORK = "work"          # 工作流模式
    ERROR = "error"        # 錯誤狀態
```

### 狀態轉換規則

| 當前狀態 | 觸發意圖 | 目標狀態 |
|:---|:---|:---|
| `IDLE` | `CHAT` | `CHAT` |
| `IDLE` | `WORK` | `WORK` |
| `CHAT` | `WORK` | `WORK` |
| `WORK` | `CHAT` | `CHAT` |
| `CHAT` | `CALL` | `IDLE` |
| `WORK` | `CALL` | `IDLE` |

### 狀態佇列與優先級

State Manager 維護狀態佇列,支援優先級:

| 優先級 | 說明 | 範例 |
|:---|:---|:---|
| `critical` | 系統級緊急狀態 | 錯誤狀態、強制停止 |
| `high` | 高優先意圖 | 工作流意圖、緊急任務 |
| `normal` | 一般意圖 | 對話意圖 |
| `low` | 低優先意圖 | 背景任務 |

---

## 2.8 Working Context (工作上下文)

**檔案位置**: `core/working_context.py`

### 設計理念

Working Context 提供跨模組資料共享機制,解決:
- 模組間需要傳遞暫存資料 (如說話者資訊、記憶檢索結果)
- 避免模組直接耦合
- 支援 TTL 自動清理過期資料

### 核心功能

1. **上下文創建**: `create_context(context_id, data, ttl_seconds)`
2. **上下文更新**: `update_context(context_id, data)`
3. **上下文查詢**: `get_context(context_id)`
4. **上下文清理**: 自動清理超過 TTL 的上下文

### 協作通道 (Collaboration Channels)

Working Context 提供兩個標準協作通道:

#### CHAT_MEM (對話記憶通道)
- **提供者**: MEM Module
- **消費者**: LLM Module
- **資料**: 相關記憶檢索結果

#### WORK_SYS (工作流通道)
- **提供者**: SYS Module
- **消費者**: LLM Module
- **資料**: 工作流執行狀態、工具調用結果

### 使用範例

```python
# STT 儲存說話者資訊
working_context.create_context(
    context_id="current_speaker",
    data={"speaker_id": "gs_alice_001", "confidence": 0.95},
    ttl_seconds=60
)

# NLP 讀取說話者資訊
speaker_info = working_context.get_context("current_speaker")
if speaker_info:
    identity = identity_manager.process_speaker(speaker_info.data["speaker_id"])
```

---

## 2.9 System Initializer (系統初始化器)

**檔案位置**: `core/system_initializer.py`

### 設計理念

System Initializer 編排系統啟動流程,確保組件依序初始化,避免依賴問題。

### 7 階段初始化流程

```
Phase 1: 核心元件 (Event Bus, State Manager)
    ↓
Phase 2: Framework (模組註冊器)
    ↓
Phase 3: Router (已棄用,保留相容性)
    ↓
Phase 4: Session Manager, Controller
    ↓
Phase 5: Working Context
    ↓
Phase 6: 模組載入 (Framework 自動發現)
    ↓
Phase 7: 健康檢查與就緒
```

### 各階段說明

| 階段 | 初始化組件 | 依賴關係 |
|:---|:---|:---|
| **Phase 1** | Event Bus, State Manager | 無依賴 (最基礎組件) |
| **Phase 2** | Framework | 需要 Event Bus |
| **Phase 3** | Router (已棄用) | 保留相容性 |
| **Phase 4** | Session Manager, Controller | 需要 Event Bus, State Manager |
| **Phase 5** | Working Context | 無額外依賴 |
| **Phase 6** | 所有模組 (STT, NLP, MEM, LLM, SYS, TTS, UI) | 需要 Framework, Event Bus |
| **Phase 7** | 健康檢查 | 執行各模組 `health_check()` |

---

## 2.10 System Loop (系統主迴圈)

**檔案位置**: `core/system_loop.py`

### 設計理念

System Loop 是系統的心跳,負責:
- 啟動 STT 持續監聽 (或接收文字輸入)
- 追蹤處理週期 (Cycle Index)
- 發布週期完成事件

### 處理流程

```
[週期開始] cycle_index = 0
    ↓
STT 監聽 / 文字輸入
    ↓
NLP 分析 → 發布 INPUT_LAYER_COMPLETE
    ↓
處理層 (MEM + LLM) → 發布 PROCESSING_LAYER_COMPLETE
    ↓
輸出層 (TTS + UI) → 發布 OUTPUT_LAYER_COMPLETE
    ↓
System Loop 發布 CYCLE_COMPLETED
    ↓
cycle_index += 1
    ↓
[下一週期開始]
```

### 週期追蹤

每個處理週期都有唯一的 `cycle_index`,用於:
- Flow-Based Deduplication (去重鍵組成部分)
- 除錯追蹤 (日誌記錄週期編號)
- 效能分析 (計算每週期處理時間)

### 文字模式支援

System Loop 支援兩種輸入模式:
- **語音模式**: 啟動 STT 持續監聽
- **文字模式**: 直接輸入文字至 NLP (測試用)

---

## 總結 (Summary)

本章節說明了 U.E.P 核心控制層的 9 個子系統:

✅ **Event Bus**: 發布/訂閱事件通訊中樞
✅ **Module Coordinator**: 三層架構協調器 + Flow 去重
✅ **Controller**: General Session 生命週期管理
✅ **Framework**: 模組註冊與效能監控
✅ **Session Manager**: 三層會話架構 (GS/CS/WS)
✅ **State Manager**: 系統狀態機與狀態佇列
✅ **Working Context**: 跨模組資料共享與協作通道
✅ **System Initializer**: 7 階段啟動編排
✅ **System Loop**: 主處理迴圈與週期追蹤

這些子系統共同構成事件驅動架構的基礎,為上層模組提供穩定的執行環境。

---

[← 上一章:系統架構](./01_系統架構.md) | [返回主文件](../System%20Design%20Documentation.md) | [下一章:模組設計 - 輸入層 →](./03_模組設計_輸入層.md)
