# ä¸‰å±¤æ¶æ§‹å¯¦ç¾æ·±åº¦åˆ†æå ±å‘Š

**ç”Ÿæˆæ™‚é–“**: 2025-10-12  
**åˆ†æç¯„åœ**: è¼¸å…¥å±¤(STT/NLP) â†’ è™•ç†å±¤(MEM/LLM/SYS) â†’ è¼¸å‡ºå±¤(TTS)  
**ç•¶å‰ç‹€æ…‹**: CHATè·¯å¾‘å·²å¯¦ç¾ï¼ŒSYSæ¨¡çµ„å¾…é‡æ§‹

---

## ğŸ“‹ ç›®éŒ„

1. [æ•´é«”æ¶æ§‹æ¦‚è¦½](#æ•´é«”æ¶æ§‹æ¦‚è¦½)
2. [å±¤ç´šæµç¨‹åˆ†æ](#å±¤ç´šæµç¨‹åˆ†æ)
3. [å·²å¯¦ç¾éƒ¨åˆ†](#å·²å¯¦ç¾éƒ¨åˆ†)
4. [éºæ¼èˆ‡å¾…å®Œå–„é …ç›®](#éºæ¼èˆ‡å¾…å®Œå–„é …ç›®)
5. [å‘äº‹ä»¶é©…å‹•é·ç§»å»ºè­°](#å‘äº‹ä»¶é©…å‹•é·ç§»å»ºè­°)
6. [å„ªå…ˆç´šæ”¹é€²å»ºè­°](#å„ªå…ˆç´šæ”¹é€²å»ºè­°)

---

## ğŸ—ï¸ æ•´é«”æ¶æ§‹æ¦‚è¦½

### æ ¸å¿ƒçµ„ä»¶é—œä¿‚åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      System Loop (ä¸»å¾ªç’°)                      â”‚
â”‚  - ç›£æ§ç‹€æ…‹è®ŠåŒ–                                                 â”‚
â”‚  - å”èª¿å¾ªç’°ç”Ÿå‘½é€±æœŸ                                             â”‚
â”‚  - æ¥æ”¶å±¤ç´šå®Œæˆé€šçŸ¥                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                          â”‚
               â–¼                          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Controller      â”‚        â”‚  Framework      â”‚
    â”‚  ç³»çµ±ç´šç›£ç£è€…      â”‚        â”‚  æ¨¡çµ„è¨»å†Šç®¡ç†    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     Module Coordinator (å”èª¿å™¨)           â”‚
    â”‚  - handle_layer_completion()             â”‚
    â”‚  - å±¤ç´šè½‰æ›é‚è¼¯                           â”‚
    â”‚  - æ¨¡çµ„èª¿ç”¨ç®¡ç†                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
           â”‚                               â”‚
           â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Router  â”‚                    â”‚  State   â”‚
    â”‚  æ–‡å­—è·¯ç”± â”‚                    â”‚  Manager â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸‰å±¤è™•ç†æµ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¼¸å…¥å±¤      â”‚  â†’   â”‚   è™•ç†å±¤      â”‚  â†’   â”‚  è¼¸å‡ºå±¤      â”‚
â”‚  STT â†’ NLP  â”‚      â”‚ MEM/LLM/SYS  â”‚      â”‚    TTS      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ å±¤ç´šæµç¨‹åˆ†æ

### 1. è¼¸å…¥å±¤ (STT â†’ NLP)

#### **ç•¶å‰å¯¦ç¾**
```python
# system_loop.py: _start_stt_listening()
STT æŒçºŒç›£è½ â†’ æ¥æ”¶èªéŸ³ â†’ è½‰æ–‡å­—
â†“
# nlp_module.py: handle()
1. è™•ç†èªè€…èº«ä»½ (_process_speaker_identity)
2. æ„åœ–åˆ†æ (_analyze_intent)
3. ç³»çµ±ç‹€æ…‹è™•ç† (_process_system_state)
4. åŸ·è¡Œç‹€æ…‹è½‰æ› (_execute_state_transition)
5. é€šçŸ¥ System Loop (_notify_system_loop_nlp_completed)
```

#### **å®Œæˆåº¦**: âœ… å®Œæ•´å¯¦ç¾

**å„ªé»**:
- NLP æ­£ç¢ºé€šçŸ¥ System Loop è¼¸å…¥å±¤å®Œæˆ
- ç‹€æ…‹è½‰æ›åœ¨è·¯ç”±å‰åŸ·è¡Œï¼Œç¢ºä¿ç³»çµ±ç‹€æ…‹æ­£ç¢º
- èˆ‡ Working Context æ•´åˆè‰¯å¥½

**ç¼ºé»**:
- ç›´æ¥èª¿ç”¨ `system_loop.handle_nlp_completion()`ï¼Œè€¦åˆåº¦é«˜
- ç¼ºå°‘éŒ¯èª¤é‡è©¦æ©Ÿåˆ¶
- STT ç›£è½é‡å•Ÿé‚è¼¯å¯èƒ½ä¸ç©©å®š

---

### 2. è™•ç†å±¤ (MEM/LLM/SYS)

#### **ç•¶å‰å¯¦ç¾ (CHATè·¯å¾‘)**

```python
# module_coordinator.py: _transition_to_processing_layer()
1. Router æ±ºå®šç›®æ¨™æ¨¡çµ„ (router.route_user_input)
2. æº–å‚™è™•ç†å±¤è«‹æ±‚ (_prepare_processing_requests)
   - CHAT: MEM + LLM
   - WORK: LLM + SYS (å¾…å¯¦ç¾)
3. æ‰¹é‡èª¿ç”¨æ¨¡çµ„ (invoke_multiple_modules)
4. æª¢æŸ¥å±¤ç´šå®Œæˆ (_check_layer_completion)
```

#### **å®Œæˆåº¦**: âš ï¸ CHATè·¯å¾‘å®Œæ•´ï¼ŒWORKè·¯å¾‘éƒ¨åˆ†å¯¦ç¾

**å·²å¯¦ç¾**:
- âœ… MEM æ¨¡çµ„èª¿ç”¨
- âœ… LLM æ¨¡çµ„èª¿ç”¨
- âœ… è™•ç†å±¤æ•¸æ“šæº–å‚™ (`_prepare_mem_input`, `_prepare_llm_input`)
- âœ… Router æ±ºç­–æ•´åˆ

**éºæ¼éƒ¨åˆ†**:
- âŒ **SYS æ¨¡çµ„æœªé‡æ§‹**ï¼ŒWORK è·¯å¾‘ç„¡æ³•å®Œæ•´é‹è¡Œ
- âŒ è™•ç†å±¤å®Œæˆå¾Œ**æœªä¸»å‹•é€šçŸ¥å”èª¿å™¨æˆ– System Loop**
- âš ï¸ `_check_layer_completion` åƒ…è¨˜éŒ„æ—¥èªŒï¼Œæœªè§¸ç™¼ä¸‹ä¸€å±¤
- âŒ ç¼ºå°‘è™•ç†å±¤éŒ¯èª¤è™•ç†å’Œé™ç´šç­–ç•¥

---

### 3. è¼¸å‡ºå±¤ (TTS)

#### **ç•¶å‰å¯¦ç¾**

```python
# module_coordinator.py: _transition_to_output_layer()
1. æå–è™•ç†å±¤å›æ‡‰æ–‡å­— (_extract_response_text)
2. Router æ±ºç­– (router.route_system_output)
3. æº–å‚™è¼¸å‡ºå±¤è¼¸å…¥ (_prepare_output_input)
4. èª¿ç”¨ TTS æ¨¡çµ„ (invoke_module)
5. é€šçŸ¥è¼¸å‡ºå®Œæˆ (_notify_output_completion)
```

#### **å®Œæˆåº¦**: âœ… åŸºæœ¬å®Œæ•´

**å·²å¯¦ç¾**:
- âœ… TTS æ¨¡çµ„èª¿ç”¨
- âœ… è¼¸å‡ºå®Œæˆé€šçŸ¥ System Loop
- âœ… èˆ‡ Status Manager æ•´åˆ

**éºæ¼éƒ¨åˆ†**:
- âš ï¸ **è™•ç†å±¤æœªä¸»å‹•è§¸ç™¼è¼¸å‡ºå±¤è½‰æ›**
- âŒ TTS æ’­æ”¾å¤±æ•—å¾Œçš„é‡è©¦é‚è¼¯ä¸å®Œå–„
- âš ï¸ è¼¸å‡ºå±¤å®Œæˆå¾Œï¼ŒSystem Loop çš„ `_complete_cycle()` å¯èƒ½ç„¡æ³•æ­£ç¢ºè§¸ç™¼

---

## âœ… å·²å¯¦ç¾éƒ¨åˆ†ç¸½çµ

### æ ¸å¿ƒåŠŸèƒ½
1. **ä¸‰å±¤æ¶æ§‹åŸºæœ¬æ¡†æ¶**
   - Module Coordinator ç®¡ç†å±¤ç´šè½‰æ›
   - System Loop ç›£æ§å¾ªç’°ç”Ÿå‘½é€±æœŸ
   - Router æä¾›æ–‡å­—è·¯ç”±æ±ºç­–

2. **CHAT è·¯å¾‘å®Œæ•´æµ**
   ```
   STT â†’ NLP â†’ Router â†’ MEM+LLM â†’ TTS
   ```

3. **æ¨¡çµ„é–“å”ä½œ**
   - NLP â†” Working Context (èº«ä»½ç®¡ç†)
   - LLM â†” MEM (è¨˜æ†¶æª¢ç´¢)
   - TTS â†” Status Manager (æƒ…æ„Ÿæ˜ å°„)

4. **ç‹€æ…‹ç®¡ç†**
   - State Manager ç¶­è­·ç³»çµ±ç‹€æ…‹
   - State Queue ç®¡ç†ç‹€æ…‹è½‰æ›ä½‡åˆ—
   - NLP åŸ·è¡Œç‹€æ…‹è½‰æ›

---

## âš ï¸ éºæ¼èˆ‡å¾…å®Œå–„é …ç›®

### ğŸ”´ é—œéµéºæ¼

#### 1. **è™•ç†å±¤æœªä¸»å‹•è§¸ç™¼ä¸‹ä¸€å±¤**
**å•é¡Œ**: 
- LLM/MEM è™•ç†å®Œæˆå¾Œï¼Œæ²’æœ‰æ˜ç¢ºå‘¼å«å”èª¿å™¨é€²è¡Œä¸‹ä¸€å±¤è½‰æ›
- ä¾è³´å”èª¿å™¨çš„ `_check_layer_completion` è¢«å‹•æª¢æŸ¥ï¼Œä½†è©²æ–¹æ³•åƒ…è¨˜éŒ„æ—¥èªŒ

**å½±éŸ¿**:
- è¼¸å‡ºå±¤å¯èƒ½ä¸æœƒè‡ªå‹•è§¸ç™¼
- å¾ªç’°å¯èƒ½å¡åœ¨è™•ç†å±¤

**å»ºè­°ä¿®å¾©**:
```python
# llm_module.py ä¸­ï¼Œè™•ç†å®Œæˆå¾Œæ‡‰è©²:
def handle(self, data: dict) -> dict:
    # ... è™•ç†é‚è¼¯ ...
    result = output.dict()
    
    # âœ… æ–°å¢ï¼šé€šçŸ¥å”èª¿å™¨è™•ç†å±¤å®Œæˆ
    self._notify_processing_layer_completion(result)
    
    return result

def _notify_processing_layer_completion(self, result: Dict[str, Any]):
    """é€šçŸ¥å”èª¿å™¨è™•ç†å±¤å®Œæˆ"""
    try:
        from core.module_coordinator import module_coordinator, ProcessingLayer
        
        module_coordinator.handle_layer_completion(
            layer=ProcessingLayer.PROCESSING,
            completion_data={
                "response": result.get("text"),
                "source_module": "llm",
                "llm_output": result,
                "timestamp": time.time()
            }
        )
    except Exception as e:
        error_log(f"[LLM] é€šçŸ¥è™•ç†å±¤å®Œæˆå¤±æ•—: {e}")
```

---

#### 2. **SYS æ¨¡çµ„æœªé‡æ§‹**
**å•é¡Œ**:
- WORK è·¯å¾‘çš„è™•ç†å±¤ç¼ºå°‘ SYS æ¨¡çµ„
- `_prepare_sys_input` å·²å¯¦ç¾ï¼Œä½† SYS æ¨¡çµ„æœ¬èº«æœªæ›´æ–°

**å½±éŸ¿**:
- ç„¡æ³•è™•ç†ç³»çµ±æŒ‡ä»¤å’Œå·¥ä½œæµ
- WORK ç‹€æ…‹ç„¡æ³•å®Œæ•´é‹è¡Œ

**å»ºè­°**:
- åƒè€ƒ LLM/MEM æ¨¡çµ„é‡æ§‹æ¨¡å¼
- ç¢ºä¿ SYS æ¨¡çµ„ä¹Ÿé€šçŸ¥å”èª¿å™¨å®Œæˆ

---

#### 3. **å¾ªç’°å®Œæˆæª¢æ¸¬ä¸ç©©å®š**
**å•é¡Œ**:
```python
# system_loop.py: _track_processing_cycle()
# ä¾è³´ç‹€æ…‹è®ŠåŒ–å’Œä½‡åˆ—é•·åº¦ä¾†åˆ¤æ–·å¾ªç’°å®Œæˆ
# ä½†ç¼ºå°‘æ˜ç¢ºçš„ã€Œè¼¸å‡ºå±¤å®Œæˆã€ä¿¡è™Ÿ
```

**å½±éŸ¿**:
- `processing_cycles` è¨ˆæ•¸å¯èƒ½ä¸æº–ç¢º
- å¾ªç’°å¯èƒ½æå‰æˆ–å»¶é²çµæŸ

**å»ºè­°ä¿®å¾©**:
```python
# system_loop.py
def _track_processing_cycle(self, current_state, queue_size):
    # æª¢æ¸¬è¼¸å‡ºå±¤å®Œæˆçš„æ˜ç¢ºä¿¡è™Ÿ
    if (self.cycle_tracking["processing_started"] and 
        not self.cycle_tracking["output_completed"]):
        
        # æª¢æŸ¥ TTS æ˜¯å¦å®Œæˆï¼ˆæ˜ç¢ºä¿¡è™Ÿï¼‰
        if self._check_tts_completion():
            self.cycle_tracking["output_completed"] = True
            self._complete_cycle()

def _check_tts_completion(self) -> bool:
    """æª¢æŸ¥ TTS æ˜¯å¦å®Œæˆï¼ˆå¾ Working Context æˆ–ç›´æ¥æŸ¥è©¢ï¼‰"""
    try:
        from core.framework import core_framework
        tts = core_framework.get_module('tts')
        if tts and hasattr(tts, 'get_playback_state'):
            from modules.tts_module.tts_module import PlaybackState
            state = tts.get_playback_state()
            return state in [PlaybackState.COMPLETED, PlaybackState.IDLE]
        return False
    except:
        return False
```

---

### ğŸŸ¡ æ¬¡è¦å•é¡Œ

#### 4. **éŒ¯èª¤è™•ç†ä¸å®Œæ•´**
- æ¨¡çµ„èª¿ç”¨å¤±æ•—å¾Œç¼ºå°‘é‡è©¦æ©Ÿåˆ¶
- é—œéµæ¨¡çµ„å¤±æ•—æ™‚ï¼Œå”èª¿å™¨æœƒåœæ­¢å¾ŒçºŒèª¿ç”¨ï¼Œä½†æ²’æœ‰é™ç´šç­–ç•¥
- ä¾‹å¦‚ï¼šLLM å¤±æ•—æ™‚ï¼Œå¯ä»¥å˜—è©¦ä½¿ç”¨é è¨­å›æ‡‰ -> æˆ‘å€‘ä¸æ‡‰è©²è€ƒæ…®é è¨­å›æ‡‰ï¼Œå¦‚æœæ¨¡çµ„èª¿ç”¨å¤±æ•—æœƒäº¤çµ¦Controlleråšä¸Šå±¤è™•ç†

#### 5. **Router è§’è‰²æ¨¡ç³Š**
**ç•¶å‰å•é¡Œ**:
- Router åœ¨è¼¸å…¥å±¤â†’è™•ç†å±¤è½‰æ›æ™‚è¢«èª¿ç”¨
- åœ¨è™•ç†å±¤â†’è¼¸å‡ºå±¤è½‰æ›æ™‚ä¹Ÿè¢«èª¿ç”¨
- ä½† Router æœ¬èº«åªæ˜¯ã€Œæ–‡å­—è·¯ç”±å™¨ã€ï¼Œä¸æ‡‰åƒèˆ‡å±¤ç´šé‚è¼¯

**å»ºè­°**:
- å°‡ Router å®šä½ç‚ºã€Œæ±ºç­–è¼”åŠ©å·¥å…·ã€
- å±¤ç´šè½‰æ›é‚è¼¯å®Œå…¨ç”± Coordinator è² è²¬
- Router åƒ…æä¾›ã€Œé€™æ®µæ–‡å­—æ‡‰è©²çµ¦èª°è™•ç†ã€çš„å»ºè­°

#### 6. **STT ç›£è½é‡å•Ÿé‚è¼¯**
```python
# system_loop.py: _restart_stt_listening()
# åœ¨å›åˆ° IDLE ç‹€æ…‹æ™‚é‡å•Ÿç›£è½ -> ä¸å°ï¼ŒSTTæ‡‰è©²æ˜¯åœ¨æ¯ä¸€æ¬¡å¾ªç’°å•Ÿå‹•æ™‚éƒ½è¦å•Ÿå‹•ç›£è½ï¼Œé™¤éç”±å…¶ä»–äº‹ä»¶æ“‹è‘— (ä¾‹å¦‚: æ­£åœ¨ä¸€å€‹å·¥ä½œæµç•¶ä¸­ï¼Œå› æ­¤è·³éè¼¸å…¥å±¤ï¼›ä½¿ç”¨è€…å°‡UEPçš„STTåŠŸèƒ½æš«æ™‚é—œé–‰ç­‰ç­‰)
# ä½†å¦‚æœ STT æ¨¡çµ„æœ¬èº«æœ‰å•é¡Œï¼Œå¯èƒ½ç„¡æ³•æ¢å¾©
```

**å»ºè­°**:
- å¢åŠ  STT å¥åº·æª¢æŸ¥
- ç›£è½å¤±æ•—å¾Œï¼Œå˜—è©¦é‡æ–°åˆå§‹åŒ– STT æ¨¡çµ„

---

## ğŸ”„ å‘äº‹ä»¶é©…å‹•é·ç§»å»ºè­°

### ç•¶å‰æ¶æ§‹å•é¡Œ
- **ç›´æ¥èª¿ç”¨**: `system_loop.handle_nlp_completion(data)` é«˜è€¦åˆ
- **åŒæ­¥é˜»å¡**: å±¤ç´šè½‰æ›å¿…é ˆç­‰å¾…ä¸Šä¸€å±¤å®Œæˆ
- **ç¼ºå°‘ç·©è¡**: å¦‚æœä¸‹ä¸€å±¤æœªå°±ç·’ï¼Œè«‹æ±‚æœƒå¤±æ•—

### äº‹ä»¶é©…å‹•æ¶æ§‹è¨­è¨ˆ

#### 1. **å¼•å…¥äº‹ä»¶ç¸½ç·š (Event Bus)**
```python
# core/event_bus.py
from typing import Dict, Callable, List
from enum import Enum
import threading

class SystemEvent(Enum):
    """ç³»çµ±äº‹ä»¶é¡å‹"""
    INPUT_LAYER_COMPLETE = "input_layer_complete"
    PROCESSING_LAYER_COMPLETE = "processing_layer_complete"
    OUTPUT_LAYER_COMPLETE = "output_layer_complete"
    MODULE_READY = "module_ready"
    MODULE_ERROR = "module_error"
    STATE_CHANGED = "state_changed"

class EventBus:
    """å…¨å±€äº‹ä»¶ç¸½ç·š"""
    def __init__(self):
        self._handlers: Dict[SystemEvent, List[Callable]] = {}
        self._lock = threading.Lock()
    
    def subscribe(self, event: SystemEvent, handler: Callable):
        """è¨‚é–±äº‹ä»¶"""
        with self._lock:
            if event not in self._handlers:
                self._handlers[event] = []
            self._handlers[event].append(handler)
    
    def publish(self, event: SystemEvent, data: Dict):
        """ç™¼å¸ƒäº‹ä»¶ï¼ˆç•°æ­¥ï¼‰"""
        with self._lock:
            handlers = self._handlers.get(event, [])
        
        for handler in handlers:
            try:
                threading.Thread(target=handler, args=(data,), daemon=True).start()
            except Exception as e:
                error_log(f"[EventBus] äº‹ä»¶è™•ç†å™¨éŒ¯èª¤: {e}")

# å…¨å±€äº‹ä»¶ç¸½ç·š
event_bus = EventBus()
```

#### 2. **æ¨¡çµ„æ”¹é€ ç¯„ä¾‹ (NLP)**
```python
# modules/nlp_module/nlp_module.py
def _notify_system_loop_nlp_completed(self, input_data, nlp_result):
    """âœ… æ”¹ç”¨äº‹ä»¶ç™¼å¸ƒ"""
    from core.event_bus import event_bus, SystemEvent
    
    event_bus.publish(
        SystemEvent.INPUT_LAYER_COMPLETE,
        {
            "input_data": input_data.model_dump(),
            "nlp_result": nlp_result.model_dump(),
            "timestamp": time.time(),
            "source_module": "nlp"
        }
    )
```

#### 3. **å”èª¿å™¨æ”¹é€ **
```python
# core/module_coordinator.py
class ModuleInvocationCoordinator:
    def __init__(self):
        # ... åŸæœ‰åˆå§‹åŒ– ...
        
        # è¨‚é–±äº‹ä»¶
        from core.event_bus import event_bus, SystemEvent
        event_bus.subscribe(SystemEvent.INPUT_LAYER_COMPLETE, self._on_input_complete)
        event_bus.subscribe(SystemEvent.PROCESSING_LAYER_COMPLETE, self._on_processing_complete)
    
    def _on_input_complete(self, data: Dict):
        """è¼¸å…¥å±¤å®Œæˆäº‹ä»¶è™•ç†å™¨"""
        self.handle_layer_completion(ProcessingLayer.INPUT, data)
    
    def _on_processing_complete(self, data: Dict):
        """è™•ç†å±¤å®Œæˆäº‹ä»¶è™•ç†å™¨"""
        self.handle_layer_completion(ProcessingLayer.PROCESSING, data)
```

#### 4. **å„ªå‹¢**
âœ… **è§£è€¦**: æ¨¡çµ„ä¸éœ€è¦çŸ¥é“ System Loop æˆ– Coordinator çš„å­˜åœ¨  
âœ… **ç•°æ­¥**: äº‹ä»¶ç™¼å¸ƒç«‹å³è¿”å›ï¼Œä¸é˜»å¡æ¨¡çµ„  
âœ… **æ“´å±•æ€§**: å¯ä»¥æœ‰å¤šå€‹è¨‚é–±è€…è™•ç†åŒä¸€äº‹ä»¶  
âœ… **å¯æ¸¬è©¦**: å¯ä»¥è¼•é¬† mock äº‹ä»¶ç¸½ç·šé€²è¡Œå–®å…ƒæ¸¬è©¦  

---

## ğŸ¯ å„ªå…ˆç´šæ”¹é€²å»ºè­°

### âœ… P0 å·²å®Œæˆ (2025-10-12)
1. âœ… **LLM æ¨¡çµ„å¢åŠ è™•ç†å±¤å®Œæˆé€šçŸ¥** - å·²å¯¦ç¾
   - æ–°å¢ `_notify_processing_layer_completion()` æ–¹æ³•
   - åœ¨ `handle()` è¿”å›å‰ç™¼å¸ƒ `PROCESSING_LAYER_COMPLETE` äº‹ä»¶
   
2. âœ… **å¼•å…¥äº‹ä»¶ç¸½ç·šåŸºç¤è¨­æ–½** - å·²å®Œæˆ
   - å‰µå»º `core/event_bus.py` å®Œæ•´å¯¦ç¾
   - NLP/LLM/TTS æ¨¡çµ„å·²é·ç§»åˆ°äº‹ä»¶é©…å‹•
   - Coordinator å’Œ System Loop å·²è¨‚é–±äº‹ä»¶

3. âœ… **è§£è€¦æ¨¡çµ„é–“ç›´æ¥èª¿ç”¨** - å·²å®Œæˆ
   - æ‰€æœ‰æ¨¡çµ„æ”¹ç”¨äº‹ä»¶ç™¼å¸ƒ
   - ä¸å†ç›´æ¥èª¿ç”¨ System Loop æˆ– Coordinator

### ğŸ”„ P1 (çŸ­æœŸå®Œæˆ)
4. ğŸ”„ **å®Œå–„å¾ªç’°å®Œæˆæª¢æ¸¬**
   - ä½¿ç”¨ TTS æ’­æ”¾ç‹€æ…‹ä½œç‚ºæ˜ç¢ºä¿¡è™Ÿ
   - ä¿®å¾© `_complete_cycle()` è§¸ç™¼é‚è¼¯
   - ç•¶å‰é€šéäº‹ä»¶æ©Ÿåˆ¶å·²æ”¹å–„ï¼Œä½†ä»éœ€å„ªåŒ–

5. ğŸ”„ **SYS æ¨¡çµ„é‡æ§‹**
   - åƒè€ƒ LLM æ¨¡çµ„çµæ§‹
   - å¯¦ç¾ WORK è·¯å¾‘å®Œæ•´æµç¨‹
   - æ·»åŠ äº‹ä»¶ç™¼å¸ƒæ©Ÿåˆ¶

6. ğŸ”„ **å¢å¼·éŒ¯èª¤è™•ç†**
   - æ¨¡çµ„èª¿ç”¨å¤±æ•—é‡è©¦æ©Ÿåˆ¶
   - é—œéµæ¨¡çµ„é™ç´šç­–ç•¥
   - äº‹ä»¶è™•ç†éŒ¯èª¤æ¢å¾©

### P2 (ä¸­æœŸå„ªåŒ–)
7. ğŸ“ **Router è·è²¬é‡å®šç¾©**
   - æ˜ç¢º Router åªè² è²¬æ–‡å­—è·¯ç”±å»ºè­°
   - å±¤ç´šè½‰æ›é‚è¼¯å®Œå…¨ç”± Coordinator è™•ç†

8. ğŸ“ **STT ç›£è½ç©©å®šæ€§æå‡**
   - å¥åº·æª¢æŸ¥æ©Ÿåˆ¶
   - è‡ªå‹•é‡å•Ÿé‚è¼¯

9. ğŸ“ **æ•ˆèƒ½ç›£æ§å¢å¼·**
   - æ¯å±¤è™•ç†æ™‚é–“çµ±è¨ˆ
   - ç“¶é ¸åˆ†æå·¥å…·

---

## ğŸ“Š æ•´é«”è©•ä¼°

### ç•¶å‰å®Œæˆåº¦
- **è¼¸å…¥å±¤**: 95% âœ…
- **è™•ç†å±¤ (CHAT)**: 75% âš ï¸
- **è™•ç†å±¤ (WORK)**: 30% âŒ
- **è¼¸å‡ºå±¤**: 85% âš ï¸
- **å”èª¿æ©Ÿåˆ¶**: 70% âš ï¸

### æ¶æ§‹å¥åº·åº¦
- **å¯ç¶­è­·æ€§**: è‰¯å¥½ (æ¨¡çµ„åŒ–æ¸…æ™°)
- **å¯æ“´å±•æ€§**: ä¸­ç­‰ (ç›´æ¥èª¿ç”¨é™åˆ¶æ“´å±•)
- **ç©©å®šæ€§**: ä¸­ç­‰ (ç¼ºå°‘éŒ¯èª¤è™•ç†)
- **æ•ˆèƒ½**: è‰¯å¥½ (å¿«å–æ©Ÿåˆ¶å®Œå–„)

---

## ğŸ”š çµè«–

ä½ çš„ä¸‰å±¤æ¶æ§‹**æ ¸å¿ƒè¨­è¨ˆæ­£ç¢º**ï¼ŒCHAT è·¯å¾‘å·²åŸºæœ¬å¯¦ç¾ï¼Œä½†å­˜åœ¨å¹¾å€‹é—œéµéºæ¼ï¼š

1. **è™•ç†å±¤æœªä¸»å‹•è§¸ç™¼ä¸‹ä¸€å±¤** (æœ€åš´é‡)
2. **SYS æ¨¡çµ„æœªé‡æ§‹** (é˜»å¡ WORK è·¯å¾‘)
3. **å¾ªç’°å®Œæˆæª¢æ¸¬ä¸ç©©å®š** (å½±éŸ¿è¨ˆæ•¸æº–ç¢ºæ€§)

å»ºè­°**å…ˆä¿®å¾© P0 é …ç›®**ï¼Œç¢ºä¿ CHAT è·¯å¾‘å®Œå…¨ç©©å®šï¼Œå†æ¨é€²äº‹ä»¶é©…å‹•é‡æ§‹ã€‚äº‹ä»¶ç¸½ç·šçš„å¼•å…¥æœƒå¤§å¹…æå‡ç³»çµ±çš„éˆæ´»æ€§å’Œå¯ç¶­è­·æ€§ã€‚

---

**å ±å‘ŠçµæŸ**
