# TR-05 效能測試報告

## 文件資訊

| 項目 | 內容 |
|------|------|
| **報告編號** | TR-05 |
| **報告名稱** | 效能測試報告 (Performance Test Report) |
| **測試版本** | v0.9.4-stable |
| **測試日期** | 2025-12-22 |
| **測試時長** | ~10 分鐘（22:27:58 ~ 22:37:30） |
| **測試環境** | Production Mode (Windows, CUDA) |
| **報告作者** | 測試團隊 |
| **報告狀態** | 完成 |

---

## 測試執行摘要

| 指標 | 數值 | 說明 |
|------|------|------|
| **測試場景總數** | 7 | 包含冷啟動、對話、工作流、休眠喚醒 |
| **已執行場景** | 6 | PERF-01 ~ PERF-06 |
| **未執行場景** | 1 | PERF-07（連續對話），MISCHIEF（設計限制） |
| **測試數據來源** | 日誌分析 | runtime-2025-12-22_22-27-58.log, debug-2025-12-22_22-27-58.log |
| **發現問題總數** | 5 | P0=1, P1=2, P2=1, P3=1 |
| **總體評估** | ⚠️ 需優化 | TTS 載入時間為主要瓶頸 |

---

## 測試場景與結果

### 場景分類

| 場景編號 | 測試名稱 | 測試次數 | 執行狀態 | 平均耗時 | 評估 |
|---------|---------|---------|---------|---------|------|
| **PERF-01** | 系統冷啟動 | 1 | ✅ 通過 | 47.6s | ⚠️ 偏慢 |
| **PERF-02** | CHAT 簡單對話 | 1 | ✅ 通過 | 36s | ⚠️ 偏慢 |
| **PERF-03** | CHAT 長文本對話 | 1 | ✅ 通過 | 73s | ⚠️ 偏慢 |
| **PERF-04** | WORK 工作流（天氣查詢） | 1 | ⚠️ 異常 | 54s¹ | ❌ 有錯誤 |
| **PERF-05** | WORK 工作流（清理垃圾桶） | 1 | ✅ 通過 | 34s | ✅ 正常 |
| **PERF-06** | SLEEP/WAKE 循環 | 1 | ⚠️ 偏慢 | 37s² | ⚠️ 需優化 |
| **PERF-07** | 連續對話 10 輪 | 0 | ❌ 未測試 | - | - |

¹ 含 Gemini 工具調用錯誤重試（29.7s）  
² WAKE 恢復時間，SLEEP 進入 <1s

---

## 詳細效能指標

### PERF-01: 系統冷啟動

**測試時間**: 22:27:58 → 22:28:46（47.60 秒）

| 模組 | 初始化耗時 | 佔比 | 關鍵操作 |
|------|-----------|------|---------|
| STT | 18.0s | 37.8% | Whisper large-v3 + 說話人識別模型載入 |
| NLP | <1s | <2% | BIO 標註器 + 意圖分析器 |
| MEM | 5.0s | 10.5% | 嵌入模型 + 向量索引 + 快照管理 |
| LLM | <1s | <2% | 學習引擎載入（21 條記錄） |
| **TTS** | **24.0s** | **50.4%** | IndexTTS 載入 + torch.compile + 預熱（5.15s） |
| SYS | <1s | <2% | 工作流註冊 + MCP 工具（38 個） |
| UI | 1.0s | 2.1% | ANI/MOV + 桌面寵物 + 設定視窗 |
| **總計** | **47.6s** | **100%** | - |

**效能瓶頸**: TTS 模組（24s，50.4%）+ STT 模組（18s，37.8%）= 88.2%

---

### PERF-02/03: CHAT 對話效能

#### 簡單對話（"Hello, how are you today"）

| 階段 | 耗時 | 說明 |
|------|------|------|
| LLM 推理 | 2.84s | 輸入 2418 tokens → 輸出 30 tokens |
| TTS 生成（3 段落） | 13.11s | 平均每段落 4.37s |
| **端到端響應** | **~36s** | 含輸入處理、路由等 |

#### 長文本對話（"Tell me a story about yourself"）

| 階段 | 耗時 | 說明 |
|------|------|------|
| LLM 推理 | 2.59s | 輸出 262 tokens |
| TTS 生成（20 段落） | 70.94s | 平均每段落 3.55s（範圍 2.11~7.56s） |
| **端到端響應** | **~73s** | 長文本處理 |

**統計**: LLM 推理時間穩定（1.62~2.84s），TTS 為主要耗時

---

### PERF-04/05: WORK 工作流效能

#### PERF-04: 天氣查詢工作流（"Can you tell me the weather"）

| 階段 | 耗時 | 說明 |
|------|------|------|
| **LLM 推理（含工具調用）** | **29.71s** | ⚠️ 異常，含 MALFORMED_FUNCTION_CALL 錯誤重試 |
| 工具調用 | 成功 | get_weather 工具 |
| TTS 生成（3 段落） | 18.12s | 工作流提示 |
| 工作流輸入處理 | 5.63s | 位置輸入 |
| **端到端響應** | **~54s** | 含錯誤處理 |

**異常**: 22:32:46 Gemini MALFORMED_FUNCTION_CALL，自動降級為 AUTO 模式重試

#### PERF-05: 清理垃圾桶工作流（"Can you clear my trash bin for me"）

| 階段 | 耗時 | 說明 |
|------|------|------|
| LLM 推理（含工具調用） | 3.20s | 正常 |
| 工具調用 | 成功 | clean_trash_bin 工具 |
| TTS 生成（3 段落） | 20.04s | 確認提示 |
| 工作流執行 | 11.03s | 清理操作 |
| **端到端響應** | **~34s** | 正常流程 |

**對比**: 正常工作流 LLM 推理時間 <5s，PERF-04 異常值 29.71s

---

### PERF-06: SLEEP/WAKE 循環

#### SLEEP 進入（22:36:41）

| 階段 | 耗時 | 說明 |
|------|------|------|
| 狀態轉換 | 即時 | IDLE → SLEEP |
| 模組卸載 | <0.1s | 6 個模組（STT, NLP, LLM, MEM, TTS, SYS） |
| 資源釋放 | <0.1s | 上下文保存至 memory/sleep_context.json |
| 動畫 | ~2s | g_to_l（ground → lying） |
| **總計** | **<1s** | ✅ 非常快 |

#### WAKE 恢復（22:36:53 ~ 22:37:30）

| 階段 | 開始時間 | 完成時間 | 耗時 | 說明 |
|------|---------|---------|------|------|
| 喚醒觸發 | 22:36:53 | - | - | SLEEP_EXITED 事件 |
| 動畫（struggle_l） | 22:36:53 | - | ~2s | 掙扎起床 |
| **模組重載** | **22:37:04** | **22:37:28** | **24.6s** | **6 個模組** |
| - NLP | 22:37:04.285 | 22:37:04.340 | 0.06s | BIO 標註器 |
| - LLM | 22:37:04.340 | 22:37:04.375 | 0.04s | Prompt 管理器 |
| - MEM | 22:37:04.375 | 22:37:07.722 | 3.35s | 嵌入模型 + 向量索引 |
| - **TTS** | **22:37:07.722** | **22:37:28.628** | **20.9s** | **IndexTTS 重載** ⚠️ |
| - SYS | 22:37:28.628 | 22:37:28.915 | 0.29s | MCP Server |
| WAKE_READY | 22:37:28.920 | - | - | 模組就緒事件 |
| 動畫（l_to_g） | 22:37:28 | 22:37:30 | ~2s | lying → ground |
| **端到端總計** | - | - | **37s** | 從觸發到完全恢復 |

**效能瓶頸**: TTS 重載（20.9s，佔 85%）

---

## LLM 推理效能統計

| 指標 | CHAT 模式 | WORK 模式 | 說明 |
|------|----------|----------|------|
| **平均推理時間** | 2.24s | 3.20s ~ 29.71s | WORK 含工具調用 |
| **最小值** | 1.62s | 3.20s | - |
| **最大值** | 2.84s | 29.71s | 異常值（含錯誤重試） |
| **Token 使用** | 30 ~ 262 | 0 ~ 45 | WORK 工具調用可能無 token |
| **成功率** | 100% | 75%¹ | 1/4 發生工具調用錯誤 |

¹ 4 次 WORK 調用中 1 次發生 MALFORMED_FUNCTION_CALL

---

## TTS 生成效能統計

| 指標 | 數值 | 說明 |
|------|------|------|
| **單段落生成時間** | 2.11 ~ 7.56s | 平均 4.35s |
| **CHAT 短文本** | 13.11s | 3 段落 |
| **CHAT 長文本** | 70.94s | 20 段落 |
| **WORK 工作流** | 18.12 ~ 20.04s | 3 段落（提示） |
| **模型載入時間** | 20 ~ 24s | 冷啟動 24s，WAKE 重載 20.9s |
| **預熱時間** | 5.15s | torch.compile + CUDA kernel |

**優化建議**: 實施段落並行生成，減少長文本總耗時

---

## 記憶體與資源使用

| 項目 | 說明 | 狀態 |
|------|------|------|
| **GPU 記憶體** | 未測量 | ⚠️ 需補充 |
| **CPU 使用率** | 未測量 | ⚠️ 需補充 |
| **記憶體洩漏** | 未檢測 | ⚠️ 需補充 |
| **SLEEP 資源釋放** | 模組卸載 <0.1s | ✅ 有效 |
| **WAKE 資源恢復** | 模組重載 24.6s | ⚠️ TTS 過慢 |

**建議**: 新增記憶體監控工具，追蹤 GPU/CPU 使用率

---

## 效能瓶頸分析

| 優先級 | 問題 | 影響範圍 | 實測數據 | 改進建議 |
|--------|------|---------|---------|---------|
| **P0** | TTS 載入時間過長 | 冷啟動、WAKE | 20~24s（佔 50~85%） | 實施模型持久化或延遲載入策略 |
| **P1** | Gemini 工具調用失敗 | WORK 路徑 | 25% 失敗率（1/4 次） | 檢查工具定義格式，加強錯誤處理 |
| **P1** | WAKE 恢復時間過長 | 使用者體驗 | 37s（TTS 佔 85%） | 優化模組重載策略，考慮背景預載 |
| **P2** | CHAT 長文本 TTS 慢 | 長回應場景 | 71s（20 段落） | 實施段落並行生成，減少序列處理 |
| **P3** | 剪貼簿監控關閉失敗 | 系統關閉 | 22:37:28 錯誤 | 修正線程池生命週期管理 |

---

## 效能改進建議

### 短期改進（1-2 週）

| 項目 | 優先級 | 預期效益 | 實施難度 |
|------|--------|---------|---------|
| 修正 Gemini 工具調用格式 | P1 | 消除 25% 錯誤率 | 低 |
| 實施 TTS 段落並行生成 | P2 | 長文本耗時減少 50% | 中 |
| 修正剪貼簿監控關閉邏輯 | P3 | 消除關閉錯誤 | 低 |

### 中期改進（1 個月）

| 項目 | 優先級 | 預期效益 | 實施難度 |
|------|--------|---------|---------|
| TTS 模型持久化機制 | P0 | 冷啟動減少 20~24s | 高 |
| WAKE 模組背景預載 | P1 | WAKE 時間減少至 <10s | 中 |
| 新增記憶體監控工具 | P2 | 可追蹤資源使用 | 中 |

### 長期改進（2-3 個月）

| 項目 | 優先級 | 預期效益 | 實施難度 |
|------|--------|---------|---------|
| 實施分散式推理架構 | P1 | LLM 推理時間減少 30% | 高 |
| TTS 模型量化優化 | P0 | 載入時間減少 50% | 高 |
| 完整效能測試自動化 | P2 | 持續效能監控 | 中 |

---

## 未測試場景

| 場景編號 | 測試名稱 | 未測試原因 | 後續計劃 |
|---------|---------|-----------|---------|
| **PERF-07** | 連續對話 10 輪 | 時間限制 | 下次測試補充，測試記憶體趨勢 |
| **MISCHIEF** | MISCHIEF 觸發與恢復 | 設計限制（無法穩定觸發） | 待 MISCHIEF 機制優化後測試 |

**建議**: 
1. PERF-07 應測試記憶體洩漏、快取效果、響應時間穩定性
2. MISCHIEF 需先解決觸發機制設計問題

---

## 需求追溯

| 需求編號 | 需求描述 | 測試場景 | 追溯狀態 |
|---------|---------|---------|---------|
| SDD-3.1 | 系統啟動時間 <60s | PERF-01 | ✅ 已覆蓋（47.6s） |
| SDD-3.2 | LLM 推理時間 <5s | PERF-02~05 | ⚠️ 部分通過（CHAT ✅, WORK ⚠️） |
| SDD-3.3 | TTS 生成流暢性 | PERF-02~05 | ⚠️ 需優化（段落生成慢） |
| SDD-3.4 | SLEEP/WAKE 功能 | PERF-06 | ⚠️ SLEEP ✅, WAKE 慢（37s） |
| SDD-3.5 | 資源管理效率 | PERF-06 | ✅ 已覆蓋（SLEEP 釋放快） |
| SDD-3.6 | 記憶體使用穩定性 | PERF-07 | ❌ 未測試 |

---

## 結論與建議

### 總體評估

| 項目 | 評估 | 說明 |
|------|------|------|
| **啟動效能** | ⚠️ 可接受 | 47.6s 符合 <60s 要求，但有優化空間 |
| **對話響應** | ⚠️ 需優化 | LLM 快（2~3s），TTS 慢（段落處理） |
| **工作流執行** | ⚠️ 有問題 | 工具調用穩定性需改進（25% 錯誤率） |
| **休眠喚醒** | ⚠️ 需優化 | SLEEP 快（<1s），WAKE 慢（37s） |
| **整體穩定性** | ✅ 良好 | 除工具調用錯誤外，系統穩定 |

### 關鍵建議

1. **立即修正** (P0/P1):
   - 修正 Gemini 工具調用格式問題
   - 實施 TTS 模型持久化或背景預載

2. **短期優化** (P2):
   - TTS 段落並行生成
   - 新增記憶體監控工具
   - 補充 PERF-07 測試

3. **長期規劃**:
   - 考慮 TTS 模型量化
   - 建立自動化效能測試框架
   - 實施效能回歸測試

### 效能目標（下一版本）

| 指標 | 當前值 | 目標值 | 改進幅度 |
|------|--------|--------|---------|
| 系統冷啟動 | 47.6s | <30s | -37% |
| WAKE 恢復 | 37s | <10s | -73% |
| WORK 工具調用成功率 | 75% | >95% | +27% |
| CHAT 長文本響應 | 73s | <40s | -45% |

---

## 附錄

### 測試數據來源

- **Runtime Log**: `logs/runtime/2025-12/runtime-2025-12-22_22-27-58.log`
- **Debug Log**: `logs/debug/2025-12/debug-2025-12-22_22-27-58.log`
- **Error Log**: `logs/error/2025-12/error-2025-12-22_22-27-58.log`

### 測試環境詳細資訊

```yaml
系統: Windows 11
Python: 3.10+
CUDA: 已啟用
模型:
  - Whisper: large-v3
  - TTS: IndexTTS Lite
  - LLM: Gemini 2.5 Flash Lite
  - 嵌入: all-MiniLM-L6-v2
執行模式: Production (--production)
```

### 相關文件

- [TR-00 測試技術與工具](./TR-00_測試技術與工具.md)
- [TR-01 單元測試報告](./TR-01_單元測試報告.md)
- [TR-02 系統測試報告](./TR-02_系統測試報告.md)
- [SDD 系統設計文件](../SDD.md)

---

**報告結束**
